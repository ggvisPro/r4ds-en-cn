<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund">
<title>5&nbsp; 数据整理 – R 数据科学 2e
（中文版）</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./workflow-scripts.html" rel="next">
<link href="./workflow-style.html" rel="prev">
<link href="./cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-cfa698a38273543b64ee69d493127e2a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script defer="" data-domain="r4ds.hadley.nz" src="https://plausible.io/js/plausible.js"></script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./whole-game.html">全局概览</a></li><li class="breadcrumb-item"><a href="./data-tidy.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据整理</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R 数据科学 2e （中文版）</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ggvisPro/r4ds-cn/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface-2e.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">第 2 版前言</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">引言</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./whole-game.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">全局概览</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-visualize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据可视化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">工作流程：基础</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据转换</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-style.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">工作流：代码风格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-tidy.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据整理</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-scripts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">工作流：脚本和项目</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">数据导入</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-help.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">工作流：获取帮助</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./visualize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">可视化</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./layers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">图层</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./EDA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">探索性数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./communication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">沟通</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">数据转换</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logicals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">逻辑向量</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numbers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">数值</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./strings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">字符串</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regexps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">正则表达式</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">因子</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datetimes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">日期和时间</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missing-values.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">缺失值</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./joins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">连接</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">导入</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spreadsheets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">电子表格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./databases.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">数据库</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./arrow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Arrow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rectangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">层级数据</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./webscraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">网络抓取</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./program.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">编程</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">函数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iteration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">迭代</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./base-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Base R 实战指南</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./communicate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">沟通</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Quarto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto-formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Quarto 格式</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#%E5%BC%95%E8%A8%80" id="toc-引言" class="nav-link active" data-scroll-target="#%E5%BC%95%E8%A8%80"><span class="header-section-number">5.1</span> 引言</a>
  <ul class="collapse">
<li><a href="#%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6" id="toc-先决条件" class="nav-link" data-scroll-target="#%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6"><span class="header-section-number">5.1.1</span> 先决条件</a></li>
  </ul>
</li>
  <li>
<a href="#sec-tidy-data" id="toc-sec-tidy-data" class="nav-link" data-scroll-target="#sec-tidy-data"><span class="header-section-number">5.2</span> 整洁数据</a>
  <ul class="collapse">
<li><a href="#%E7%BB%83%E4%B9%A0" id="toc-练习" class="nav-link" data-scroll-target="#%E7%BB%83%E4%B9%A0"><span class="header-section-number">5.2.1</span> 练习</a></li>
  </ul>
</li>
  <li>
<a href="#sec-pivoting" id="toc-sec-pivoting" class="nav-link" data-scroll-target="#sec-pivoting"><span class="header-section-number">5.3</span> 拉长数据</a>
  <ul class="collapse">
<li><a href="#sec-billboard" id="toc-sec-billboard" class="nav-link" data-scroll-target="#sec-billboard"><span class="header-section-number">5.3.1</span> 列名中包含数据</a></li>
  <li><a href="#%E8%BD%AC%E6%8D%A2%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84" id="toc-转换是如何工作的" class="nav-link" data-scroll-target="#%E8%BD%AC%E6%8D%A2%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="header-section-number">5.3.2</span> 转换是如何工作的？</a></li>
  <li><a href="#%E5%88%97%E5%90%8D%E4%B8%AD%E5%8C%85%E5%90%AB%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F" id="toc-列名中包含多个变量" class="nav-link" data-scroll-target="#%E5%88%97%E5%90%8D%E4%B8%AD%E5%8C%85%E5%90%AB%E5%A4%9A%E4%B8%AA%E5%8F%98%E9%87%8F"><span class="header-section-number">5.3.3</span> 列名中包含多个变量</a></li>
  <li><a href="#%E5%88%97%E6%A0%87%E9%A2%98%E4%B8%AD%E5%8C%85%E5%90%AB%E6%95%B0%E6%8D%AE%E5%92%8C%E5%8F%98%E9%87%8F%E5%90%8D" id="toc-列标题中包含数据和变量名" class="nav-link" data-scroll-target="#%E5%88%97%E6%A0%87%E9%A2%98%E4%B8%AD%E5%8C%85%E5%90%AB%E6%95%B0%E6%8D%AE%E5%92%8C%E5%8F%98%E9%87%8F%E5%90%8D"><span class="header-section-number">5.3.4</span> 列标题中包含数据和变量名</a></li>
  </ul>
</li>
  <li>
<a href="#%E5%8A%A0%E5%AE%BD%E6%95%B0%E6%8D%AE" id="toc-加宽数据" class="nav-link" data-scroll-target="#%E5%8A%A0%E5%AE%BD%E6%95%B0%E6%8D%AE"><span class="header-section-number">5.4</span> 加宽数据</a>
  <ul class="collapse">
<li><a href="#pivot_wider-%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84" id="toc-pivot_wider-是如何工作的" class="nav-link" data-scroll-target="#pivot_wider-%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="header-section-number">5.4.1</span> <code>pivot_wider()</code> 是如何工作的？</a></li>
  </ul>
</li>
  <li><a href="#%E5%B0%8F%E7%BB%93" id="toc-小结" class="nav-link" data-scroll-target="#%E5%B0%8F%E7%BB%93"><span class="header-section-number">5.5</span> 小结</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/ggvisPro/r4ds-cn/edit/main/data-tidy.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/ggvisPro/r4ds-cn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./whole-game.html">全局概览</a></li><li class="breadcrumb-item"><a href="./data-tidy.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据整理</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-data-tidy" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据整理</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="引言" class="level2" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="引言">
<span class="header-section-number">5.1</span> 引言</h2>
<blockquote class="blockquote">
<p>“Happy families are all alike; every unhappy family is unhappy in its own way.”<br>
— Leo Tolstoy<br>
“幸福的家庭都是相似的；不幸的家庭各有各的不幸。” &nbsp; — 列夫·托尔斯泰</p>
</blockquote>
<blockquote class="blockquote">
<p>“Tidy datasets are all alike, but every messy dataset is messy in its own way.”<br>
— Hadley Wickham<br>
“整洁的数据集都是相似的，但每个凌乱的数据集各有各的凌乱。”<br>
— 哈德利·威克姆</p>
</blockquote>
<p>在本章中，你将学习一种使用名为<strong>整洁数据</strong> (tidy data) 的系统来在 R 中一致地组织数据的方法。将数据转换成这种格式需要一些前期工作，但从长远来看，这些工作是值得的。一旦你有了整洁的数据和 tidyverse 中各个包提供的整洁工具，你将花更少的时间在不同表示形式之间转换数据，从而能将更多时间用于你所关心的数据问题上。</p>
<p>在本章中，你将首先学习整洁数据的定义，并看到它如何应用于一个简单的示例数据集。然后，我们将深入探讨你将用于整理数据的主要工具：转换 (pivoting)。转换可以让你在不改变任何值的情况下改变数据的形态。</p>
<section id="先决条件" class="level3" data-number="5.1.1"><h3 data-number="5.1.1" class="anchored" data-anchor-id="先决条件">
<span class="header-section-number">5.1.1</span> 先决条件</h3>
<p>在本章中，我们将重点关注 tidyr，这是一个提供了大量工具来帮助你整理凌乱数据集的包。tidyr 是核心 tidyverse 的成员之一。</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>从本章开始，我们将抑制 <code><a href="https://tidyverse.tidyverse.org">library(tidyverse)</a></code> 加载时显示的消息。</p>
</section></section><section id="sec-tidy-data" class="level2" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="sec-tidy-data">
<span class="header-section-number">5.2</span> 整洁数据</h2>
<p>你可以用多种方式来表示相同的基础数据。下面的例子展示了用三种不同方式组织的相同数据。每个数据集都显示了四个变量的相同值：<em>country</em> (国家)、<em>year</em> (年份)、<em>population</em> (人口) 和记录在案的 <em>cases</em> (结核病案例) 数量，但每个数据集以不同的方式组织这些值。</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">table1</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 4</span></span>
<span><span class="co">#&gt;   country      year  cases population</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan  1999    745   19987071</span></span>
<span><span class="co">#&gt; 2 Afghanistan  2000   2666   20595360</span></span>
<span><span class="co">#&gt; 3 Brazil       1999  37737  172006362</span></span>
<span><span class="co">#&gt; 4 Brazil       2000  80488  174504898</span></span>
<span><span class="co">#&gt; 5 China        1999 212258 1272915272</span></span>
<span><span class="co">#&gt; 6 China        2000 213766 1280428583</span></span>
<span></span>
<span><span class="va">table2</span></span>
<span><span class="co">#&gt; # A tibble: 12 × 4</span></span>
<span><span class="co">#&gt;   country      year type           count</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan  1999 cases            745</span></span>
<span><span class="co">#&gt; 2 Afghanistan  1999 population  19987071</span></span>
<span><span class="co">#&gt; 3 Afghanistan  2000 cases           2666</span></span>
<span><span class="co">#&gt; 4 Afghanistan  2000 population  20595360</span></span>
<span><span class="co">#&gt; 5 Brazil       1999 cases          37737</span></span>
<span><span class="co">#&gt; 6 Brazil       1999 population 172006362</span></span>
<span><span class="co">#&gt; # ℹ 6 more rows</span></span>
<span></span>
<span><span class="va">table3</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 3</span></span>
<span><span class="co">#&gt;   country      year rate             </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;            </span></span>
<span><span class="co">#&gt; 1 Afghanistan  1999 745/19987071     </span></span>
<span><span class="co">#&gt; 2 Afghanistan  2000 2666/20595360    </span></span>
<span><span class="co">#&gt; 3 Brazil       1999 37737/172006362  </span></span>
<span><span class="co">#&gt; 4 Brazil       2000 80488/174504898  </span></span>
<span><span class="co">#&gt; 5 China        1999 212258/1272915272</span></span>
<span><span class="co">#&gt; 6 China        2000 213766/1280428583</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这些都是相同基础数据的表示形式，但它们的使用便利性并不相同。其中之一，<code>table1</code>，在 tidyverse 中使用起来会容易得多，因为它是<strong>整洁的</strong> (tidy)。</p>
<p>有三条相互关联的规则可以使一个数据集变得整洁：</p>
<ol type="1">
<li>每个变量是一列；每列是一个变量。</li>
<li>每个观测是一行；每行是一个观测。</li>
<li>每个值是一个单元格；每个单元格是一个值。</li>
</ol>
<p><a href="#fig-tidy-structure" class="quarto-xref">Figure&nbsp;<span>5.1</span></a> 直观地展示了这些规则。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-tidy-structure" class="quarto-float quarto-figure quarto-figure-center anchored" alt="三个面板，每个代表一个整洁的数据框。第一个面板显示每个变量是一列。第二个面板显示每个观测是一行。第三个面板显示每个值是一个单元格。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-tidy-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/tidy-1.png" class="img-fluid figure-img" alt="三个面板，每个代表一个整洁的数据框。第一个面板显示每个变量是一列。第二个面板显示每个观测是一行。第三个面板显示每个值是一个单元格。" width="683">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tidy-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.1: 以下三条规则构成一个整洁的数据集：变量是列，观测是行，值是单元格。
</figcaption></figure>
</div>
</div>
</div>
<p>为什么需要确保你的数据是整洁的呢？主要有两个优点：</p>
<ol type="1">
<li><p>选择一种一致的方式来存储数据具有普遍的优势。如果你有了一致的数据结构，学习使用与之配套的工具就会更容易，因为它们具有内在的一致性。</p></li>
<li><p>将变量放在列中有其特殊的优势，因为这能让 R 的向量化特性大放异彩。正如你在 <a href="data-transform.html#sec-mutate" class="quarto-xref"><span>Section 3.3.1</span></a> 和 <a href="data-transform.html#sec-summarize" class="quarto-xref"><span>Section 3.5.2</span></a> 中学到的，大多数内置的 R 函数都处理值的向量。这使得转换整洁数据感觉特别自然。</p></li>
</ol>
<p>dplyr、ggplot2 以及 tidyverse 中的所有其他包都是为处理整洁数据而设计的。以下是一些小例子，展示了你可能会如何使用 <code>table1</code>。</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 计算每万人的比率</span></span>
<span><span class="va">table1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="va">cases</span> <span class="op">/</span> <span class="va">population</span> <span class="op">*</span> <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 5</span></span>
<span><span class="co">#&gt;   country      year  cases population  rate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan  1999    745   19987071 0.373</span></span>
<span><span class="co">#&gt; 2 Afghanistan  2000   2666   20595360 1.29 </span></span>
<span><span class="co">#&gt; 3 Brazil       1999  37737  172006362 2.19 </span></span>
<span><span class="co">#&gt; 4 Brazil       2000  80488  174504898 4.61 </span></span>
<span><span class="co">#&gt; 5 China        1999 212258 1272915272 1.67 </span></span>
<span><span class="co">#&gt; 6 China        2000 213766 1280428583 1.67</span></span>
<span></span>
<span><span class="co"># 计算每年的总病例数</span></span>
<span><span class="va">table1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>total_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cases</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;    year total_cases</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  1999      250740</span></span>
<span><span class="co">#&gt; 2  2000      296920</span></span>
<span></span>
<span><span class="co"># 可视化随时间的变化</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">table1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">cases</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">country</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">country</span>, shape <span class="op">=</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1999</span>, <span class="fl">2000</span><span class="op">)</span><span class="op">)</span> <span class="co"># x 轴刻度在 1999 和 2000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="data-tidy_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" alt="该图显示了阿富汗、巴西和中国在 1999 年和 2000 年的病例数，x 轴是年份，y 轴是病例数。图上的每个点代表一个国家在某一年份的病例数。每个国家的点通过颜色和形状与其他国家区分开，并用线连接，形成了三条不平行、不相交的线。中国的病例数在 1999 年和 2000 年都是最高的，两年都超过了 200,000。巴西的病例数在 1999 年约为 40,000，在 2000 年约为 75,000。阿富汗的病例数在 1999 年和 2000 年都是最低的，在这个尺度上其值看起来非常接近 0。" width="480"></p>
</figure>
</div>
</div>
</div>
<section id="练习" class="level3" data-number="5.2.1"><h3 data-number="5.2.1" class="anchored" data-anchor-id="练习">
<span class="header-section-number">5.2.1</span> 练习</h3>
<ol type="1">
<li><p>对于每个示例表格，描述每个观测和每列代表什么。</p></li>
<li>
<p>简要描述你将如何为 <code>table2</code> 和 <code>table3</code> 计算 <code>rate</code> 的过程。你需要执行四个操作：</p>
<ol type="a">
<li>提取每个国家每年的结核病病例数。</li>
<li>提取每个国家每年匹配的人口数。</li>
<li>将病例数除以人口数，然后乘以 10000。</li>
<li>将结果存回适当的位置。</li>
</ol>
<p>你还没有学到实际执行这些操作所需的所有函数，但你应该能够思考出你需要的转换过程。</p>
</li>
</ol></section></section><section id="sec-pivoting" class="level2" data-number="5.3"><h2 data-number="5.3" class="anchored" data-anchor-id="sec-pivoting">
<span class="header-section-number">5.3</span> 拉长数据</h2>
<p>整洁数据的原则可能看起来如此显而易见，以至于你可能会怀疑自己是否会遇到不整洁的数据集。然而，不幸的是，大多数真实数据都是不整洁的。主要有两个原因：</p>
<ol type="1">
<li><p>数据的组织方式通常是为了方便某些分析之外的目标。例如，为了方便数据录入而非分析而组织数据是很常见的。</p></li>
<li><p>大多数人并不熟悉整洁数据的原则，除非你花大量时间处理数据，否则很难自己推导出这些原则。</p></li>
</ol>
<p>这意味着大多数真实的分析至少需要一些整理工作。你将从弄清楚基础的变量和观测是什么开始。有时这很容易；其他时候你可能需要咨询最初生成数据的人。接下来，你将<strong>转换</strong> (pivot) 你的数据，使其成为变量在列、观测在行的整洁形式。</p>
<p>tidyr 提供了两个用于转换数据的函数：<code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> 和 <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code>。我们先从 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> 开始，因为这是最常见的情况。让我们来看一些例子。</p>
<section id="sec-billboard" class="level3" data-number="5.3.1"><h3 data-number="5.3.1" class="anchored" data-anchor-id="sec-billboard">
<span class="header-section-number">5.3.1</span> 列名中包含数据</h3>
<p><code>billboard</code> 数据集记录了 2000 年歌曲的广告牌排名：</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">billboard</span></span>
<span><span class="co">#&gt; # A tibble: 317 × 79</span></span>
<span><span class="co">#&gt;   artist       track               date.entered   wk1   wk2   wk3   wk4   wk5</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;        &lt;chr&gt;               &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 2 Pac        Baby Don't Cry (Ke… 2000-02-26      87    82    72    77    87</span></span>
<span><span class="co">#&gt; 2 2Ge+her      The Hardest Part O… 2000-09-02      91    87    92    NA    NA</span></span>
<span><span class="co">#&gt; 3 3 Doors Down Kryptonite          2000-04-08      81    70    68    67    66</span></span>
<span><span class="co">#&gt; 4 3 Doors Down Loser               2000-10-21      76    76    72    69    67</span></span>
<span><span class="co">#&gt; 5 504 Boyz     Wobble Wobble       2000-04-15      57    34    25    17    17</span></span>
<span><span class="co">#&gt; 6 98^0         Give Me Just One N… 2000-08-19      51    39    34    26    26</span></span>
<span><span class="co">#&gt; # ℹ 311 more rows</span></span>
<span><span class="co">#&gt; # ℹ 71 more variables: wk6 &lt;dbl&gt;, wk7 &lt;dbl&gt;, wk8 &lt;dbl&gt;, wk9 &lt;dbl&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在这个数据集中，每个观测是一首歌。前三列 (<code>artist</code>, <code>track</code> 和 <code>date.entered</code>) 是描述歌曲的变量。然后我们有 76 列 (<code>wk1</code>-<code>wk76</code>) 描述了歌曲在每周的排名<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。在这里，列名是一个变量 (周，<code>week</code>)，而单元格的值是另一个变量 (排名，<code>rank</code>)。</p>
<p>为了整理这个数据，我们将使用 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code>：</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">billboard</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"wk"</span><span class="op">)</span>, </span>
<span>    names_to <span class="op">=</span> <span class="st">"week"</span>, </span>
<span>    values_to <span class="op">=</span> <span class="st">"rank"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 24,092 × 5</span></span>
<span><span class="co">#&gt;    artist track                   date.entered week   rank</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt;                   &lt;date&gt;       &lt;chr&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk1      87</span></span>
<span><span class="co">#&gt;  2 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk2      82</span></span>
<span><span class="co">#&gt;  3 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk3      72</span></span>
<span><span class="co">#&gt;  4 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk4      77</span></span>
<span><span class="co">#&gt;  5 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk5      87</span></span>
<span><span class="co">#&gt;  6 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk6      94</span></span>
<span><span class="co">#&gt;  7 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk7      99</span></span>
<span><span class="co">#&gt;  8 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk8      NA</span></span>
<span><span class="co">#&gt;  9 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk9      NA</span></span>
<span><span class="co">#&gt; 10 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk10     NA</span></span>
<span><span class="co">#&gt; # ℹ 24,082 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在数据之后，有三个关键参数：</p>
<ul>
<li>
<code>cols</code> 指定哪些列需要被转换，即哪些列不是变量。这个参数使用与 <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> 相同的语法，所以在这里我们可以使用 <code>!c(artist, track, date.entered)</code> 或 <code>starts_with("wk")</code>。</li>
<li>
<code>names_to</code> 为存储在列名中的变量命名，我们将其命名为 <code>week</code>。</li>
<li>
<code>values_to</code> 为存储在单元格值中的变量命名，我们将其命名为 <code>rank</code>。</li>
</ul>
<p>请注意，在代码中 <code>"week"</code> 和 <code>"rank"</code> 是带引号的，因为它们是我们正在创建的新变量，在运行 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> 调用时它们还不存在于数据中。</p>
<p>现在让我们把注意力转向结果中这个更长的数据框。如果一首歌在前 100 名的时间少于 76 周会发生什么？以 2 Pac 的 “Baby Don’t Cry” 为例。上面的输出表明它只在前 100 名中待了 7 周，所有剩余的周都用缺失值填充。这些 <code>NA</code> 并不真正代表未知的观测；它们是被数据集的结构强制存在的<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>，所以我们可以通过设置 <code>values_drop_na = TRUE</code> 来让 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> 移除它们：</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">billboard</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"wk"</span><span class="op">)</span>, </span>
<span>    names_to <span class="op">=</span> <span class="st">"week"</span>, </span>
<span>    values_to <span class="op">=</span> <span class="st">"rank"</span>,</span>
<span>    values_drop_na <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 5,307 × 5</span></span>
<span><span class="co">#&gt;   artist track                   date.entered week   rank</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;chr&gt;                   &lt;date&gt;       &lt;chr&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk1      87</span></span>
<span><span class="co">#&gt; 2 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk2      82</span></span>
<span><span class="co">#&gt; 3 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk3      72</span></span>
<span><span class="co">#&gt; 4 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk4      77</span></span>
<span><span class="co">#&gt; 5 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk5      87</span></span>
<span><span class="co">#&gt; 6 2 Pac  Baby Don't Cry (Keep... 2000-02-26   wk6      94</span></span>
<span><span class="co">#&gt; # ℹ 5,301 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>现在行数少了很多，这表明许多带有 <code>NA</code> 的行被删除了。</p>
<p>你可能还会想，如果一首歌在前 100 名的时间超过 76 周会发生什么？我们无法从这些数据中得知，但你可能会猜到，数据集中会添加额外的列 <code>wk77</code>、<code>wk78</code>……</p>
<p>这个数据现在是整洁的了，但我们可以通过使用 <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 和 <code><a href="https://readr.tidyverse.org/reference/parse_number.html">readr::parse_number()</a></code> 将 <code>week</code> 的值从字符字符串转换为数字，来使未来的计算更容易一些。<code><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number()</a></code> 是一个方便的函数，它会从字符串中提取第一个数字，忽略所有其他文本。</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">billboard_longer</span> <span class="op">&lt;-</span> <span class="va">billboard</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"wk"</span><span class="op">)</span>, </span>
<span>    names_to <span class="op">=</span> <span class="st">"week"</span>, </span>
<span>    values_to <span class="op">=</span> <span class="st">"rank"</span>,</span>
<span>    values_drop_na <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    week <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_number.html">parse_number</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">billboard_longer</span></span>
<span><span class="co">#&gt; # A tibble: 5,307 × 5</span></span>
<span><span class="co">#&gt;   artist track                   date.entered  week  rank</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;chr&gt;                   &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 2 Pac  Baby Don't Cry (Keep... 2000-02-26       1    87</span></span>
<span><span class="co">#&gt; 2 2 Pac  Baby Don't Cry (Keep... 2000-02-26       2    82</span></span>
<span><span class="co">#&gt; 3 2 Pac  Baby Don't Cry (Keep... 2000-02-26       3    72</span></span>
<span><span class="co">#&gt; 4 2 Pac  Baby Don't Cry (Keep... 2000-02-26       4    77</span></span>
<span><span class="co">#&gt; 5 2 Pac  Baby Don't Cry (Keep... 2000-02-26       5    87</span></span>
<span><span class="co">#&gt; 6 2 Pac  Baby Don't Cry (Keep... 2000-02-26       6    94</span></span>
<span><span class="co">#&gt; # ℹ 5,301 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>现在我们把所有的周数都放在一个变量里，所有的排名值都放在另一个变量里，我们就很方便地可以可视化歌曲排名随时间的变化了。代码如下所示，结果在 <a href="#fig-billboard-ranks" class="quarto-xref">Figure&nbsp;<span>5.2</span></a> 中。我们可以看到，很少有歌曲在前 100 名中停留超过 20 周。</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">billboard_longer</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">rank</span>, group <span class="op">=</span> <span class="va">track</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-billboard-ranks" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个折线图，x 轴是周数，y 轴是排名，每条线代表一首歌。大多数歌曲似乎从一个高排名开始，迅速攀升到一个低排名（排名数字小），然后再次下滑。在周数大于 20 且排名大于 50 的区域，歌曲数量出奇地少。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-billboard-ranks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="data-tidy_files/figure-html/fig-billboard-ranks-1.png" class="img-fluid figure-img" alt="一个折线图，x 轴是周数，y 轴是排名，每条线代表一首歌。大多数歌曲似乎从一个高排名开始，迅速攀升到一个低排名（排名数字小），然后再次下滑。在周数大于 20 且排名大于 50 的区域，歌曲数量出奇地少。" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-billboard-ranks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.2: 一个折线图，显示了歌曲排名随时间的变化。
</figcaption></figure>
</div>
</div>
</div>
</section><section id="转换是如何工作的" class="level3" data-number="5.3.2"><h3 data-number="5.3.2" class="anchored" data-anchor-id="转换是如何工作的">
<span class="header-section-number">5.3.2</span> 转换是如何工作的？</h3>
<p>现在你已经看到了我们如何使用转换来重塑数据，让我们花一点时间来直观地理解转换对数据做了什么。让我们从一个非常简单的数据集开始，以便更容易地看到发生了什么。假设我们有三个病人，<code>id</code> 分别是 A、B 和 C，我们对每个病人进行了两次血压测量。我们将用 <code><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble()</a></code> 创建数据，这是一个方便手动构建小型 tibble 的函数：</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">id</span>,  <span class="op">~</span><span class="va">bp1</span>, <span class="op">~</span><span class="va">bp2</span>,</span>
<span>   <span class="st">"A"</span>,   <span class="fl">100</span>,  <span class="fl">120</span>,</span>
<span>   <span class="st">"B"</span>,   <span class="fl">140</span>,  <span class="fl">115</span>,</span>
<span>   <span class="st">"C"</span>,   <span class="fl">120</span>,  <span class="fl">125</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>我们希望我们的新数据集有三个变量：<code>id</code> (已存在)、<code>measurement</code> (测量，即列名) 和 <code>value</code> (值，即单元格值)。为了实现这一点，我们需要将 <code>df</code> 拉长：</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="va">bp1</span><span class="op">:</span><span class="va">bp2</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"measurement"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 3</span></span>
<span><span class="co">#&gt;   id    measurement value</span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 A     bp1           100</span></span>
<span><span class="co">#&gt; 2 A     bp2           120</span></span>
<span><span class="co">#&gt; 3 B     bp1           140</span></span>
<span><span class="co">#&gt; 4 B     bp2           115</span></span>
<span><span class="co">#&gt; 5 C     bp1           120</span></span>
<span><span class="co">#&gt; 6 C     bp2           125</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>重塑是如何工作的呢？如果我们逐列思考，就更容易理解了。如 <a href="#fig-pivot-variables" class="quarto-xref">Figure&nbsp;<span>5.3</span></a> 所示，原始数据集中已经是变量的列中的值 (<code>id</code>) 需要被重复，每个被转换的列重复一次。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pivot-variables" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个图表，展示了 `pivot_longer()` 如何转换一个简单的数据集，用颜色突出显示了 `id` 列中的值（“A”、“B”、“C”）在输出中每个都重复了两次，因为有两个列（“bp1”和“bp2”）正在被转换。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pivot-variables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/tidy-data/variables.png" class="img-fluid figure-img" alt="一个图表，展示了 `pivot_longer()` 如何转换一个简单的数据集，用颜色突出显示了 `id` 列中的值（“A”、“B”、“C”）在输出中每个都重复了两次，因为有两个列（“bp1”和“bp2”）正在被转换。" width="515">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pivot-variables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.3: 已经是变量的列需要被重复，每个被转换的列重复一次。
</figcaption></figure>
</div>
</div>
</div>
<p>列名会成为一个新变量中的值，该新变量的名称由 <code>names_to</code> 定义，如 <a href="#fig-pivot-names" class="quarto-xref">Figure&nbsp;<span>5.4</span></a> 所示。它们需要为原始数据集中的每一行重复一次。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pivot-names" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个图表，展示了 `pivot_longer()` 如何转换一个简单的数据集，用颜色突出显示了列名（“bp1”和“bp2”）如何成为新的 `measurement` 列中的值。它们被重复了三次，因为输入中有三行。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pivot-names-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/tidy-data/column-names.png" class="img-fluid figure-img" alt="一个图表，展示了 `pivot_longer()` 如何转换一个简单的数据集，用颜色突出显示了列名（“bp1”和“bp2”）如何成为新的 `measurement` 列中的值。它们被重复了三次，因为输入中有三行。" width="515">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pivot-names-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.4: 被转换列的列名成为新列中的值。这些值需要为原始数据集的每一行重复一次。
</figcaption></figure>
</div>
</div>
</div>
<p>单元格的值也成为一个新变量中的值，其名称由 <code>values_to</code> 定义。它们被逐行展开。<a href="#fig-pivot-values" class="quarto-xref">Figure&nbsp;<span>5.5</span></a> 展示了这个过程。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pivot-values" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个图表，展示了 `pivot_longer()` 如何转换数据，用颜色突出显示了单元格的值（血压测量值）如何成为新的 `value` 列中的值。它们被逐行展开，所以原始的行 (100,120)，然后 (140,115)，再然后 (120,125)，变成了一个从 100 到 125 的列。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pivot-values-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/tidy-data/cell-values.png" class="img-fluid figure-img" alt="一个图表，展示了 `pivot_longer()` 如何转换数据，用颜色突出显示了单元格的值（血压测量值）如何成为新的 `value` 列中的值。它们被逐行展开，所以原始的行 (100,120)，然后 (140,115)，再然后 (120,125)，变成了一个从 100 到 125 的列。" width="515">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pivot-values-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.5: 值的数量被保留（不重复），但被逐行展开。
</figcaption></figure>
</div>
</div>
</div>
</section><section id="列名中包含多个变量" class="level3" data-number="5.3.3"><h3 data-number="5.3.3" class="anchored" data-anchor-id="列名中包含多个变量">
<span class="header-section-number">5.3.3</span> 列名中包含多个变量</h3>
<p>一个更具挑战性的情况是，当你的列名中塞入了多条信息，而你希望将这些信息存储在不同的新变量中时。例如，拿 <code>who2</code> 数据集来说，这是你上面看到的 <code>table1</code> 及其他表格的来源：</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">who2</span></span>
<span><span class="co">#&gt; # A tibble: 7,240 × 58</span></span>
<span><span class="co">#&gt;   country      year sp_m_014 sp_m_1524 sp_m_2534 sp_m_3544 sp_m_4554</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan  1980       NA        NA        NA        NA        NA</span></span>
<span><span class="co">#&gt; 2 Afghanistan  1981       NA        NA        NA        NA        NA</span></span>
<span><span class="co">#&gt; 3 Afghanistan  1982       NA        NA        NA        NA        NA</span></span>
<span><span class="co">#&gt; 4 Afghanistan  1983       NA        NA        NA        NA        NA</span></span>
<span><span class="co">#&gt; 5 Afghanistan  1984       NA        NA        NA        NA        NA</span></span>
<span><span class="co">#&gt; 6 Afghanistan  1985       NA        NA        NA        NA        NA</span></span>
<span><span class="co">#&gt; # ℹ 7,234 more rows</span></span>
<span><span class="co">#&gt; # ℹ 51 more variables: sp_m_5564 &lt;dbl&gt;, sp_m_65 &lt;dbl&gt;, sp_f_014 &lt;dbl&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这个由世界卫生组织收集的数据集记录了关于结核病诊断的信息。有两列已经是变量并且很容易解释：<code>country</code> 和 <code>year</code>。它们后面跟着 56 列，如 <code>sp_m_014</code>、<code>ep_m_4554</code> 和 <code>rel_m_3544</code>。如果你盯着这些列足够长的时间，你会注意到一个模式。每个列名都由三部分组成，用 <code>_</code> 分隔。第一部分，<code>sp</code>/<code>rel</code>/<code>ep</code>，描述了诊断所用的方法；第二部分，<code>m</code>/<code>f</code> 是 <code>gender</code> (性别，在这个数据集中编码为二元变量)；第三部分，<code>014</code>/<code>1524</code>/<code>2534</code>/<code>3544</code>/<code>4554</code>/<code>5564</code>/<code>65</code> 是 <code>age</code> (年龄) 范围 (例如，<code>014</code> 代表 0-14 岁)。</p>
<p>所以在这种情况下，我们在 <code>who2</code> 中记录了六条信息：国家和年份 (已经是列)；诊断方法、性别类别和年龄范围类别 (包含在其他列名中)；以及该类别中的患者计数 (单元格值)。为了将这六条信息组织在六个独立的列中，我们使用 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code>，并为 <code>names_to</code> 提供一个列名向量，为 <code>names_sep</code> 提供将原始变量名拆分成块的指令，以及为 <code>values_to</code> 提供一个列名：</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">who2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="op">!</span><span class="op">(</span><span class="va">country</span><span class="op">:</span><span class="va">year</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"diagnosis"</span>, <span class="st">"gender"</span>, <span class="st">"age"</span><span class="op">)</span>, </span>
<span>    names_sep <span class="op">=</span> <span class="st">"_"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 405,440 × 6</span></span>
<span><span class="co">#&gt;   country      year diagnosis gender age   count</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan  1980 sp        m      014      NA</span></span>
<span><span class="co">#&gt; 2 Afghanistan  1980 sp        m      1524     NA</span></span>
<span><span class="co">#&gt; 3 Afghanistan  1980 sp        m      2534     NA</span></span>
<span><span class="co">#&gt; 4 Afghanistan  1980 sp        m      3544     NA</span></span>
<span><span class="co">#&gt; 5 Afghanistan  1980 sp        m      4554     NA</span></span>
<span><span class="co">#&gt; 6 Afghanistan  1980 sp        m      5564     NA</span></span>
<span><span class="co">#&gt; # ℹ 405,434 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>names_sep</code> 的一个替代方案是 <code>names_pattern</code>，在你学习了 <a href="regexps.html" class="quarto-xref"><span>Chapter 15</span></a> 中的正则表达式后，可以用它从更复杂的命名场景中提取变量。</p>
<p>从概念上讲，这只是你已经看过的更简单情况的一个小变种。<a href="#fig-pivot-multiple-names" class="quarto-xref">Figure&nbsp;<span>5.6</span></a> 展示了基本思想：现在，列名不再是转换成单个列，而是转换成多个列。你可以想象这分两步发生 (先转换再分离)，但实际上它是在一个步骤中完成的，因为这样更快。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pivot-multiple-names" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个图表，用颜色说明了提供 `names_sep` 和多个 `names_to` 如何在输出中创建多个变量。输入有变量名“x_1”和“y_2”，它们被“_”分割，以在输出中创建 name 和 number 列。这与只有一个 `names_to` 的情况类似，但原本会是一个单一输出变量的现在被分成了多个变量。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pivot-multiple-names-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/tidy-data/multiple-names.png" class="img-fluid figure-img" alt="一个图表，用颜色说明了提供 `names_sep` 和多个 `names_to` 如何在输出中创建多个变量。输入有变量名“x_1”和“y_2”，它们被“_”分割，以在输出中创建 name 和 number 列。这与只有一个 `names_to` 的情况类似，但原本会是一个单一输出变量的现在被分成了多个变量。" width="524">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pivot-multiple-names-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.6: 转换名称中包含多条信息的列，意味着每个列名现在都会填充到输出的多个列中。
</figcaption></figure>
</div>
</div>
</div>
</section><section id="列标题中包含数据和变量名" class="level3" data-number="5.3.4"><h3 data-number="5.3.4" class="anchored" data-anchor-id="列标题中包含数据和变量名">
<span class="header-section-number">5.3.4</span> 列标题中包含数据和变量名</h3>
<p>复杂性的下一个台阶是当列名中混合了变量值和变量名。例如，拿 <code>household</code> 数据集来说：</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">household</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 5</span></span>
<span><span class="co">#&gt;   family dob_child1 dob_child2 name_child1 name_child2</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;date&gt;     &lt;date&gt;     &lt;chr&gt;       &lt;chr&gt;      </span></span>
<span><span class="co">#&gt; 1      1 1998-11-26 2000-01-29 Susan       Jose       </span></span>
<span><span class="co">#&gt; 2      2 1996-06-22 NA         Mark        &lt;NA&gt;       </span></span>
<span><span class="co">#&gt; 3      3 2002-07-11 2004-04-05 Sam         Seth       </span></span>
<span><span class="co">#&gt; 4      4 2004-10-10 2009-08-27 Craig       Khai       </span></span>
<span><span class="co">#&gt; 5      5 2000-12-05 2005-02-28 Parker      Gracie</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这个数据集包含了五个家庭的数据，以及最多两个孩子的姓名和出生日期。这个数据集中的新挑战是，列名包含了两个变量的名称 (<code>dob</code>、<code>name</code>) 和另一个变量 (<code>child</code>，值为 1 或 2) 的值。为了解决这个问题，我们再次需要向 <code>names_to</code> 提供一个向量，但这次我们使用特殊的 <code>".value"</code> 指示符；这不是一个变量名，而是一个告诉 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> 做些不同事情的唯一值。这会覆盖通常的 <code>values_to</code> 参数，转而使用被转换列名的第一部分作为输出中的变量名。</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">household</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="op">!</span><span class="va">family</span>, </span>
<span>    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".value"</span>, <span class="st">"child"</span><span class="op">)</span>, </span>
<span>    names_sep <span class="op">=</span> <span class="st">"_"</span>, </span>
<span>    values_drop_na <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 9 × 4</span></span>
<span><span class="co">#&gt;   family child  dob        name </span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;chr&gt;  &lt;date&gt;     &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1      1 child1 1998-11-26 Susan</span></span>
<span><span class="co">#&gt; 2      1 child2 2000-01-29 Jose </span></span>
<span><span class="co">#&gt; 3      2 child1 1996-06-22 Mark </span></span>
<span><span class="co">#&gt; 4      3 child1 2002-07-11 Sam  </span></span>
<span><span class="co">#&gt; 5      3 child2 2004-04-05 Seth </span></span>
<span><span class="co">#&gt; 6      4 child1 2004-10-10 Craig</span></span>
<span><span class="co">#&gt; # ℹ 3 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>我们再次使用 <code>values_drop_na = TRUE</code>，因为输入的形状强制创建了显式的缺失变量 (例如，对于只有一个孩子的家庭)。</p>
<p><a href="#fig-pivot-names-and-values" class="quarto-xref">Figure&nbsp;<span>5.7</span></a> 用一个更简单的例子阐述了基本思想。当你在 <code>names_to</code> 中使用 <code>".value"</code> 时，输入中的列名同时贡献了输出中的值和变量名。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pivot-names-and-values" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个图表，用颜色说明了特殊的 &quot;.value&quot; 指示符是如何工作的。输入有名称 &quot;x_1&quot;、&quot;x_2&quot;、&quot;y_1&quot; 和 &quot;y_2&quot;，我们希望使用第一部分（&quot;x&quot;、&quot;y&quot;）作为变量名，第二部分（&quot;1&quot;、&quot;2&quot;）作为新 &quot;num&quot; 列的值。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pivot-names-and-values-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/tidy-data/names-and-values.png" class="img-fluid figure-img" alt="一个图表，用颜色说明了特殊的 &quot;.value&quot; 指示符是如何工作的。输入有名称 &quot;x_1&quot;、&quot;x_2&quot;、&quot;y_1&quot; 和 &quot;y_2&quot;，我们希望使用第一部分（&quot;x&quot;、&quot;y&quot;）作为变量名，第二部分（&quot;1&quot;、&quot;2&quot;）作为新 &quot;num&quot; 列的值。" width="474">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pivot-names-and-values-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.7: 使用 <code>names_to = c(".value", "num")</code> 进行转换会将列名分成两个部分：第一部分决定输出列的名称（<code>x</code> 或 <code>y</code>），第二部分决定 <code>num</code> 列的值。
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="加宽数据" class="level2" data-number="5.4"><h2 data-number="5.4" class="anchored" data-anchor-id="加宽数据">
<span class="header-section-number">5.4</span> 加宽数据</h2>
<p>到目前为止，我们已经使用 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> 来解决一类常见的问题，即值最终出现在列名中。接下来，我们将转向 <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code>，它通过增加列数和减少行数来使数据集<strong>变宽</strong>，并在一个观测分布在多行时提供帮助。这种情况在现实世界中似乎不那么常见，但在处理政府数据时似乎经常出现。</p>
<p>我们将从查看 <code>cms_patient_experience</code> 开始，这是一个来自医疗保险和医疗补助服务中心的数据集，收集了关于患者体验的数据：</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cms_patient_experience</span></span>
<span><span class="co">#&gt; # A tibble: 500 × 5</span></span>
<span><span class="co">#&gt;   org_pac_id org_nm                     measure_cd   measure_title   prf_rate</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;      &lt;chr&gt;                      &lt;chr&gt;        &lt;chr&gt;              &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 0446157747 USC CARE MEDICAL GROUP INC CAHPS_GRP_1  CAHPS for MIPS…       63</span></span>
<span><span class="co">#&gt; 2 0446157747 USC CARE MEDICAL GROUP INC CAHPS_GRP_2  CAHPS for MIPS…       87</span></span>
<span><span class="co">#&gt; 3 0446157747 USC CARE MEDICAL GROUP INC CAHPS_GRP_3  CAHPS for MIPS…       86</span></span>
<span><span class="co">#&gt; 4 0446157747 USC CARE MEDICAL GROUP INC CAHPS_GRP_5  CAHPS for MIPS…       57</span></span>
<span><span class="co">#&gt; 5 0446157747 USC CARE MEDICAL GROUP INC CAHPS_GRP_8  CAHPS for MIPS…       85</span></span>
<span><span class="co">#&gt; 6 0446157747 USC CARE MEDICAL GROUP INC CAHPS_GRP_12 CAHPS for MIPS…       24</span></span>
<span><span class="co">#&gt; # ℹ 494 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>被研究的核心单位是一个组织，但每个组织都分布在六行中，每一行对应于在该组织调查中进行的一次测量。我们可以通过使用 <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> 来查看 <code>measure_cd</code> 和 <code>measure_title</code> 的完整值集：</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cms_patient_experience</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">measure_cd</span>, <span class="va">measure_title</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 2</span></span>
<span><span class="co">#&gt;   measure_cd   measure_title                                                 </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;        &lt;chr&gt;                                                         </span></span>
<span><span class="co">#&gt; 1 CAHPS_GRP_1  CAHPS for MIPS SSM: Getting Timely Care, Appointments, and In…</span></span>
<span><span class="co">#&gt; 2 CAHPS_GRP_2  CAHPS for MIPS SSM: How Well Providers Communicate            </span></span>
<span><span class="co">#&gt; 3 CAHPS_GRP_3  CAHPS for MIPS SSM: Patient's Rating of Provider              </span></span>
<span><span class="co">#&gt; 4 CAHPS_GRP_5  CAHPS for MIPS SSM: Health Promotion and Education            </span></span>
<span><span class="co">#&gt; 5 CAHPS_GRP_8  CAHPS for MIPS SSM: Courteous and Helpful Office Staff        </span></span>
<span><span class="co">#&gt; 6 CAHPS_GRP_12 CAHPS for MIPS SSM: Stewardship of Patient Resources</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这两列都不会成为特别好的变量名：<code>measure_cd</code> 没有暗示变量的含义，而 <code>measure_title</code> 是一个包含空格的长句子。我们现在将使用 <code>measure_cd</code> 作为新列名的来源，但在实际分析中，你可能想要创建既简短又有意义的自己的变量名。</p>
<p><code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> 的接口与 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> 相反：我们不是选择新的列名，而是需要提供定义值的现有列 (<code>values_from</code>) 和定义列名的列 (<code>names_from</code>)：</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cms_patient_experience</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">measure_cd</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">prf_rate</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 500 × 9</span></span>
<span><span class="co">#&gt;   org_pac_id org_nm                   measure_title   CAHPS_GRP_1 CAHPS_GRP_2</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;      &lt;chr&gt;                    &lt;chr&gt;                 &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 0446157747 USC CARE MEDICAL GROUP … CAHPS for MIPS…          63          NA</span></span>
<span><span class="co">#&gt; 2 0446157747 USC CARE MEDICAL GROUP … CAHPS for MIPS…          NA          87</span></span>
<span><span class="co">#&gt; 3 0446157747 USC CARE MEDICAL GROUP … CAHPS for MIPS…          NA          NA</span></span>
<span><span class="co">#&gt; 4 0446157747 USC CARE MEDICAL GROUP … CAHPS for MIPS…          NA          NA</span></span>
<span><span class="co">#&gt; 5 0446157747 USC CARE MEDICAL GROUP … CAHPS for MIPS…          NA          NA</span></span>
<span><span class="co">#&gt; 6 0446157747 USC CARE MEDICAL GROUP … CAHPS for MIPS…          NA          NA</span></span>
<span><span class="co">#&gt; # ℹ 494 more rows</span></span>
<span><span class="co">#&gt; # ℹ 4 more variables: CAHPS_GRP_3 &lt;dbl&gt;, CAHPS_GRP_5 &lt;dbl&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>输出看起来不太对；我们似乎每个组织仍然有多行。这是因为，我们还需要告诉 <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> 哪个或哪些列的值唯一标识每一行；在这种情况下，是那些以 <code>"org"</code> 开头的变量：</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cms_patient_experience</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    id_cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"org"</span><span class="op">)</span>,</span>
<span>    names_from <span class="op">=</span> <span class="va">measure_cd</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">prf_rate</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 95 × 8</span></span>
<span><span class="co">#&gt;   org_pac_id org_nm           CAHPS_GRP_1 CAHPS_GRP_2 CAHPS_GRP_3 CAHPS_GRP_5</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;      &lt;chr&gt;                  &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 0446157747 USC CARE MEDICA…          63          87          86          57</span></span>
<span><span class="co">#&gt; 2 0446162697 ASSOCIATION OF …          59          85          83          63</span></span>
<span><span class="co">#&gt; 3 0547164295 BEAVER MEDICAL …          49          NA          75          44</span></span>
<span><span class="co">#&gt; 4 0749333730 CAPE PHYSICIANS…          67          84          85          65</span></span>
<span><span class="co">#&gt; 5 0840104360 ALLIANCE PHYSIC…          66          87          87          64</span></span>
<span><span class="co">#&gt; 6 0840109864 REX HOSPITAL INC          73          87          84          67</span></span>
<span><span class="co">#&gt; # ℹ 89 more rows</span></span>
<span><span class="co">#&gt; # ℹ 2 more variables: CAHPS_GRP_8 &lt;dbl&gt;, CAHPS_GRP_12 &lt;dbl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这样我们就得到了我们想要的输出。</p>
<section id="pivot_wider-是如何工作的" class="level3" data-number="5.4.1"><h3 data-number="5.4.1" class="anchored" data-anchor-id="pivot_wider-是如何工作的">
<span class="header-section-number">5.4.1</span> <code>pivot_wider()</code> 是如何工作的？</h3>
<p>为了理解 <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> 是如何工作的，让我们再次从一个非常简单的数据集开始。这次我们有两个病人，<code>id</code> 分别是 A 和 B，我们对病人 A 进行了三次血压测量，对病人 B 进行了两次：</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">id</span>, <span class="op">~</span><span class="va">measurement</span>, <span class="op">~</span><span class="va">value</span>,</span>
<span>  <span class="st">"A"</span>,        <span class="st">"bp1"</span>,    <span class="fl">100</span>,</span>
<span>  <span class="st">"B"</span>,        <span class="st">"bp1"</span>,    <span class="fl">140</span>,</span>
<span>  <span class="st">"B"</span>,        <span class="st">"bp2"</span>,    <span class="fl">115</span>, </span>
<span>  <span class="st">"A"</span>,        <span class="st">"bp2"</span>,    <span class="fl">120</span>,</span>
<span>  <span class="st">"A"</span>,        <span class="st">"bp3"</span>,    <span class="fl">105</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>我们将从 <code>value</code> 列取值，从 <code>measurement</code> 列取名：</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">measurement</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">value</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   id      bp1   bp2   bp3</span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 A       100   120   105</span></span>
<span><span class="co">#&gt; 2 B       140   115    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>为了开始这个过程，<code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> 首先需要弄清楚行和列中将放什么。新的列名将是 <code>measurement</code> 的唯一值。</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">measurement</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "bp1" "bp2" "bp3"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>默认情况下，输出中的行由所有不进入新名称或值的变量决定。这些被称为 <code>id_cols</code>。这里只有一个列，但通常可以有任意数量。</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">measurement</span>, <span class="op">-</span><span class="va">value</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 1</span></span>
<span><span class="co">#&gt;   id   </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 A    </span></span>
<span><span class="co">#&gt; 2 B</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然后 <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> 结合这些结果生成一个空的数据框：</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">measurement</span>, <span class="op">-</span><span class="va">value</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NA</span>, y <span class="op">=</span> <span class="cn">NA</span>, z <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   id    x     y     z    </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt;</span></span>
<span><span class="co">#&gt; 1 A     NA    NA    NA   </span></span>
<span><span class="co">#&gt; 2 B     NA    NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然后它用输入中的数据填充所有缺失值。在这种情况下，并非输出中的每个单元格在输入中都有对应的值，因为病人 B 没有第三次血压测量，所以那个单元格保持缺失。我们将在 <a href="missing-values.html" class="quarto-xref"><span>Chapter 18</span></a> 中回到 <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> 可以“制造”缺失值的这个概念。</p>
<p>你可能还会想，如果输入中有多个行对应于输出中的一个单元格会发生什么。下面的例子有两行对应于 <code>id</code> “A” 和 <code>measurement</code> “bp1”：</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">id</span>, <span class="op">~</span><span class="va">measurement</span>, <span class="op">~</span><span class="va">value</span>,</span>
<span>  <span class="st">"A"</span>,        <span class="st">"bp1"</span>,    <span class="fl">100</span>,</span>
<span>  <span class="st">"A"</span>,        <span class="st">"bp1"</span>,    <span class="fl">102</span>,</span>
<span>  <span class="st">"A"</span>,        <span class="st">"bp2"</span>,    <span class="fl">120</span>,</span>
<span>  <span class="st">"B"</span>,        <span class="st">"bp1"</span>,    <span class="fl">140</span>, </span>
<span>  <span class="st">"B"</span>,        <span class="st">"bp2"</span>,    <span class="fl">115</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果我们尝试转换这个，我们会得到一个包含列表列 (list-columns) 的输出，你将在 <a href="rectangling.html" class="quarto-xref"><span>Chapter 23</span></a> 中学到更多关于它的知识：</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="va">measurement</span>,</span>
<span>    values_from <span class="op">=</span> <span class="va">value</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Values from `value` are not uniquely identified; output will contain</span></span>
<span><span class="co">#&gt; list-cols.</span></span>
<span><span class="co">#&gt; • Use `values_fn = list` to suppress this warning.</span></span>
<span><span class="co">#&gt; • Use `values_fn = {summary_fun}` to summarise duplicates.</span></span>
<span><span class="co">#&gt; • Use the following dplyr code to identify duplicates.</span></span>
<span><span class="co">#&gt;   {data} |&gt;</span></span>
<span><span class="co">#&gt;   dplyr::summarise(n = dplyr::n(), .by = c(id, measurement)) |&gt;</span></span>
<span><span class="co">#&gt;   dplyr::filter(n &gt; 1L)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 3</span></span>
<span><span class="co">#&gt;   id    bp1       bp2      </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;list&gt;    &lt;list&gt;   </span></span>
<span><span class="co">#&gt; 1 A     &lt;dbl [2]&gt; &lt;dbl [1]&gt;</span></span>
<span><span class="co">#&gt; 2 B     &lt;dbl [1]&gt; &lt;dbl [1]&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>因为你还不知道如何处理这种数据，你可能需要根据警告中的提示来找出问题所在：</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">measurement</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   id    measurement     n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;       &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 A     bp1             2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然后就得由你来弄清楚你的数据出了什么问题，要么修复底层的数据损坏，要么使用你的分组和汇总技能来确保行和列值的每个组合只有一个单行。</p>
</section></section><section id="小结" class="level2" data-number="5.5"><h2 data-number="5.5" class="anchored" data-anchor-id="小结">
<span class="header-section-number">5.5</span> 小结</h2>
<p>在本章中，你学习了关于整洁数据的知识：即变量在列、观测在行的数据。整洁数据使得在 tidyverse 中工作更容易，因为它是一个被大多数函数所理解的一致结构，主要的挑战是将你收到的任何结构的数据转换成整洁的格式。为此，你学习了 <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer()</a></code> 和 <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code>，它们可以让你整理许多不整洁的数据集。我们在这里展示的例子是从 <code><a href="https://tidyr.tidyverse.org/articles/pivot.html">vignette("pivot", package = "tidyr")</a></code> 中挑选的一部分，所以如果你遇到的问题本章没有帮助你解决，那么那个小品文是一个值得尝试的下一个地方。</p>
<p>另一个挑战是，对于一个给定的数据集，可能无法将更长或更宽的版本标记为“整洁”的那个。这部分反映了我们对整洁数据的定义，我们说整洁数据每个列中有一个变量，但我们实际上没有定义什么是变量 (而且定义它出奇地困难)。务实地说，一个变量可以是任何使你的分析最容易的东西，这是完全可以接受的。所以如果你在 figuring out 如何进行某些计算时卡住了，考虑改变你的数据组织方式；不要害怕按需进行非整洁化、转换和重新整洁化！</p>
<p>如果你喜欢本章并想了解更多关于其底层理论的知识，你可以在发表于《统计软件杂志》(Journal of Statistical Software) 的论文 <a href="https://www.jstatsoft.org/article/view/v059i10">Tidy Data</a> 中了解更多关于其历史和理论基础。</p>
<p>现在你正在编写大量的 R 代码，是时候学习更多关于将你的代码组织到文件和目录中的知识了。在下一章中，你将学习到脚本和项目的所有优点，以及它们提供的许多使你的生活更轻松的工具。</p>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>只要一首歌在 2000 年的某个时间点进入过前 100 名，它就会被收录，并且在出现后最多被追踪 72 周。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>我们将在 <a href="missing-values.html" class="quarto-xref"><span>Chapter 18</span></a> 中回到这个概念。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/ggvispro\.github\.io\/r4ds-cn\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./workflow-style.html" class="pagination-link" aria-label="工作流：代码风格">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">工作流：代码风格</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./workflow-scripts.html" class="pagination-link" aria-label="工作流：脚本和项目">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">工作流：脚本和项目</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ggvisPro/r4ds-cn/edit/main/data-tidy.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/ggvisPro/r4ds-cn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>