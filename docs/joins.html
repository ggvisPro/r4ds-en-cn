<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund">
<title>19&nbsp; 连接 – R 数据科学 2e
（中文版）</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./import.html" rel="next">
<link href="./missing-values.html" rel="prev">
<link href="./cover.jpg" rel="icon" type="image/jpeg">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-cfa698a38273543b64ee69d493127e2a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script defer="" data-domain="r4ds.hadley.nz" src="https://plausible.io/js/plausible.js"></script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./transform.html">数据转换</a></li><li class="breadcrumb-item"><a href="./joins.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">连接</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R 数据科学 2e （中文版）</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ggvisPro/r4ds-cn/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface-2e.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">第 2 版前言</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">引言</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./whole-game.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">全局概览</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-visualize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据可视化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">工作流程：基础</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据转换</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-style.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">工作流：代码风格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-tidy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据整理</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-scripts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">工作流：脚本和项目</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data-import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">数据导入</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow-help.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">工作流：获取帮助</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./visualize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">可视化</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./layers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">图层</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./EDA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">探索性数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./communication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">沟通</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">数据转换</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./logicals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">逻辑向量</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numbers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">数值</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./strings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">字符串</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regexps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">正则表达式</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">因子</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datetimes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">日期和时间</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missing-values.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">缺失值</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./joins.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">连接</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">导入</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spreadsheets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">电子表格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./databases.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">数据库</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./arrow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Arrow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rectangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">层级数据</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./webscraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">网络抓取</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./program.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">编程</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">函数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iteration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">迭代</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./base-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Base R 实战指南</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./communicate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">沟通</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Quarto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quarto-formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Quarto 格式</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#%E5%BC%95%E8%A8%80" id="toc-引言" class="nav-link active" data-scroll-target="#%E5%BC%95%E8%A8%80"><span class="header-section-number">19.1</span> 引言</a>
  <ul class="collapse">
<li><a href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6" id="toc-前提条件" class="nav-link" data-scroll-target="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="header-section-number">19.1.1</span> 前提条件</a></li>
  </ul>
</li>
  <li>
<a href="#%E9%94%AE" id="toc-键" class="nav-link" data-scroll-target="#%E9%94%AE"><span class="header-section-number">19.2</span> 键</a>
  <ul class="collapse">
<li><a href="#%E4%B8%BB%E9%94%AE%E5%92%8C%E5%A4%96%E9%94%AE" id="toc-主键和外键" class="nav-link" data-scroll-target="#%E4%B8%BB%E9%94%AE%E5%92%8C%E5%A4%96%E9%94%AE"><span class="header-section-number">19.2.1</span> 主键和外键</a></li>
  <li><a href="#%E6%A3%80%E6%9F%A5%E4%B8%BB%E9%94%AE" id="toc-检查主键" class="nav-link" data-scroll-target="#%E6%A3%80%E6%9F%A5%E4%B8%BB%E9%94%AE"><span class="header-section-number">19.2.2</span> 检查主键</a></li>
  <li><a href="#%E4%BB%A3%E7%90%86%E9%94%AE" id="toc-代理键" class="nav-link" data-scroll-target="#%E4%BB%A3%E7%90%86%E9%94%AE"><span class="header-section-number">19.2.3</span> 代理键</a></li>
  <li><a href="#%E7%BB%83%E4%B9%A0" id="toc-练习" class="nav-link" data-scroll-target="#%E7%BB%83%E4%B9%A0"><span class="header-section-number">19.2.4</span> 练习</a></li>
  </ul>
</li>
  <li>
<a href="#sec-mutating-joins" id="toc-sec-mutating-joins" class="nav-link" data-scroll-target="#sec-mutating-joins"><span class="header-section-number">19.3</span> 基本连接</a>
  <ul class="collapse">
<li><a href="#%E5%8F%98%E8%BF%9E%E6%8E%A5" id="toc-变连接" class="nav-link" data-scroll-target="#%E5%8F%98%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.3.1</span> 变连接</a></li>
  <li><a href="#%E6%8C%87%E5%AE%9A%E8%BF%9E%E6%8E%A5%E9%94%AE" id="toc-指定连接键" class="nav-link" data-scroll-target="#%E6%8C%87%E5%AE%9A%E8%BF%9E%E6%8E%A5%E9%94%AE"><span class="header-section-number">19.3.2</span> 指定连接键</a></li>
  <li><a href="#%E8%BF%87%E6%BB%A4%E8%BF%9E%E6%8E%A5" id="toc-过滤连接" class="nav-link" data-scroll-target="#%E8%BF%87%E6%BB%A4%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.3.3</span> 过滤连接</a></li>
  <li><a href="#%E7%BB%83%E4%B9%A0-1" id="toc-练习-1" class="nav-link" data-scroll-target="#%E7%BB%83%E4%B9%A0-1"><span class="header-section-number">19.3.4</span> 练习</a></li>
  </ul>
</li>
  <li>
<a href="#%E8%BF%9E%E6%8E%A5%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C" id="toc-连接如何工作" class="nav-link" data-scroll-target="#%E8%BF%9E%E6%8E%A5%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C"><span class="header-section-number">19.4</span> 连接如何工作？</a>
  <ul class="collapse">
<li><a href="#%E8%A1%8C%E5%8C%B9%E9%85%8D" id="toc-行匹配" class="nav-link" data-scroll-target="#%E8%A1%8C%E5%8C%B9%E9%85%8D"><span class="header-section-number">19.4.1</span> 行匹配</a></li>
  <li><a href="#%E8%BF%87%E6%BB%A4%E8%BF%9E%E6%8E%A5-1" id="toc-过滤连接-1" class="nav-link" data-scroll-target="#%E8%BF%87%E6%BB%A4%E8%BF%9E%E6%8E%A5-1"><span class="header-section-number">19.4.2</span> 过滤连接</a></li>
  </ul>
</li>
  <li>
<a href="#sec-non-equi-joins" id="toc-sec-non-equi-joins" class="nav-link" data-scroll-target="#sec-non-equi-joins"><span class="header-section-number">19.5</span> 非等值连接</a>
  <ul class="collapse">
<li><a href="#%E4%BA%A4%E5%8F%89%E8%BF%9E%E6%8E%A5" id="toc-交叉连接" class="nav-link" data-scroll-target="#%E4%BA%A4%E5%8F%89%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.5.1</span> 交叉连接</a></li>
  <li><a href="#%E4%B8%8D%E7%AD%89%E8%BF%9E%E6%8E%A5" id="toc-不等连接" class="nav-link" data-scroll-target="#%E4%B8%8D%E7%AD%89%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.5.2</span> 不等连接</a></li>
  <li><a href="#%E6%BB%9A%E5%8A%A8%E8%BF%9E%E6%8E%A5" id="toc-滚动连接" class="nav-link" data-scroll-target="#%E6%BB%9A%E5%8A%A8%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.5.3</span> 滚动连接</a></li>
  <li><a href="#%E9%87%8D%E5%8F%A0%E8%BF%9E%E6%8E%A5" id="toc-重叠连接" class="nav-link" data-scroll-target="#%E9%87%8D%E5%8F%A0%E8%BF%9E%E6%8E%A5"><span class="header-section-number">19.5.4</span> 重叠连接</a></li>
  <li><a href="#%E7%BB%83%E4%B9%A0-2" id="toc-练习-2" class="nav-link" data-scroll-target="#%E7%BB%83%E4%B9%A0-2"><span class="header-section-number">19.5.5</span> 练习</a></li>
  </ul>
</li>
  <li><a href="#%E6%80%BB%E7%BB%93" id="toc-总结" class="nav-link" data-scroll-target="#%E6%80%BB%E7%BB%93"><span class="header-section-number">19.6</span> 总结</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/ggvisPro/r4ds-cn/edit/main/joins.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/ggvisPro/r4ds-cn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./transform.html">数据转换</a></li><li class="breadcrumb-item"><a href="./joins.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">连接</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-joins" class="quarto-section-identifier"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">连接</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="引言" class="level2" data-number="19.1"><h2 data-number="19.1" class="anchored" data-anchor-id="引言">
<span class="header-section-number">19.1</span> 引言</h2>
<p>数据分析很少只涉及单个数据框。通常你会有多个数据框，并且必须将它们<strong>连接 (join)</strong> 在一起以回答你感兴趣的问题。本章将向你介绍两种重要的连接类型：</p>
<ul>
<li>变连接 (Mutating joins)，它将一个数据框中的匹配观测值的新变量添加到另一个数据框中。</li>
<li>过滤连接 (Filtering joins)，它根据一个数据框中的观测值是否与另一个数据框中的观测值匹配来过滤该数据框中的观测值。</li>
</ul>
<p>我们将首先讨论键 (keys)，即用于在连接中连接一对数据框的变量。我们将通过检查 nycflights13 包中数据集的键来巩固理论，然后利用这些知识开始连接数据框。接下来，我们将讨论连接的工作原理，重点关注它们对行的操作。最后，我们将讨论非等值连接 (non-equi joins)，这是一类连接，它提供了一种比默认的相等关系更灵活的键匹配方式。</p>
<section id="前提条件" class="level3" data-number="19.1.1"><h3 data-number="19.1.1" class="anchored" data-anchor-id="前提条件">
<span class="header-section-number">19.1.1</span> 前提条件</h3>
<p>在本章中，我们将使用 dplyr 中的连接函数来探索 nycflights13 中的五个相关数据集。</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="键" class="level2" data-number="19.2"><h2 data-number="19.2" class="anchored" data-anchor-id="键">
<span class="header-section-number">19.2</span> 键</h2>
<p>要理解连接，你首先需要了解两个表如何通过每个表内的一对键连接起来。在本节中，你将学习两种类型的键，并在 nycflights13 包的数据集中看到这两种键的示例。你还将学习如何检查你的键是否有效，以及当你的表缺少键时该怎么办。</p>
<section id="主键和外键" class="level3" data-number="19.2.1"><h3 data-number="19.2.1" class="anchored" data-anchor-id="主键和外键">
<span class="header-section-number">19.2.1</span> 主键和外键</h3>
<p>每个连接都涉及一对键：一个主键和一个外键。 <strong>主键 (primary key)</strong> 是一个或一组唯一标识每个观测值的变量。当需要多个变量时，该键称为<strong>复合键 (compound key)</strong>。例如，在 nycflights13 中：</p>
<ul>
<li>
<p><code>airlines</code> 记录了关于每家航空公司的两条数据：其航空公司代码和全名。你可以用它的两个字母的航空公司代码来识别一家航空公司，这使得 <code>carrier</code> 成为主键。</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airlines</span></span>
<span><span class="co">#&gt; # A tibble: 16 × 2</span></span>
<span><span class="co">#&gt;   carrier name                    </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;                   </span></span>
<span><span class="co">#&gt; 1 9E      Endeavor Air Inc.       </span></span>
<span><span class="co">#&gt; 2 AA      American Airlines Inc.  </span></span>
<span><span class="co">#&gt; 3 AS      Alaska Airlines Inc.    </span></span>
<span><span class="co">#&gt; 4 B6      JetBlue Airways         </span></span>
<span><span class="co">#&gt; 5 DL      Delta Air Lines Inc.    </span></span>
<span><span class="co">#&gt; 6 EV      ExpressJet Airlines Inc.</span></span>
<span><span class="co">#&gt; # ℹ 10 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><code>airports</code> 记录了关于每个机场的数据。你可以用它的三个字母的机场代码来识别每个机场，这使得 <code>faa</code> 成为主键。</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span></span>
<span><span class="co">#&gt; # A tibble: 1,458 × 8</span></span>
<span><span class="co">#&gt;   faa   name                            lat   lon   alt    tz dst  </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;                         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 04G   Lansdowne Airport              41.1 -80.6  1044    -5 A    </span></span>
<span><span class="co">#&gt; 2 06A   Moton Field Municipal Airport  32.5 -85.7   264    -6 A    </span></span>
<span><span class="co">#&gt; 3 06C   Schaumburg Regional            42.0 -88.1   801    -6 A    </span></span>
<span><span class="co">#&gt; 4 06N   Randall Airport                41.4 -74.4   523    -5 A    </span></span>
<span><span class="co">#&gt; 5 09J   Jekyll Island Airport          31.1 -81.4    11    -5 A    </span></span>
<span><span class="co">#&gt; 6 0A9   Elizabethton Municipal Airpo…  36.4 -82.2  1593    -5 A    </span></span>
<span><span class="co">#&gt; # ℹ 1,452 more rows</span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: tzone &lt;chr&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><code>planes</code> 记录了关于每架飞机的数据。你可以用它的尾号来识别一架飞机，这使得 <code>tailnum</code> 成为主键。</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">planes</span></span>
<span><span class="co">#&gt; # A tibble: 3,322 × 9</span></span>
<span><span class="co">#&gt;   tailnum  year type              manufacturer    model     engines</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;int&gt; &lt;chr&gt;             &lt;chr&gt;           &lt;chr&gt;       &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 N10156   2004 Fixed wing multi… EMBRAER         EMB-145XR       2</span></span>
<span><span class="co">#&gt; 2 N102UW   1998 Fixed wing multi… AIRBUS INDUSTR… A320-214        2</span></span>
<span><span class="co">#&gt; 3 N103US   1999 Fixed wing multi… AIRBUS INDUSTR… A320-214        2</span></span>
<span><span class="co">#&gt; 4 N104UW   1999 Fixed wing multi… AIRBUS INDUSTR… A320-214        2</span></span>
<span><span class="co">#&gt; 5 N10575   2002 Fixed wing multi… EMBRAER         EMB-145LR       2</span></span>
<span><span class="co">#&gt; 6 N105UW   1999 Fixed wing multi… AIRBUS INDUSTR… A320-214        2</span></span>
<span><span class="co">#&gt; # ℹ 3,316 more rows</span></span>
<span><span class="co">#&gt; # ℹ 3 more variables: seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><code>weather</code> 记录了始发机场的天气数据。你可以通过位置和时间的组合来识别每个观测值，这使得 <code>origin</code> 和 <code>time_hour</code> 成为复合主键。</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weather</span></span>
<span><span class="co">#&gt; # A tibble: 26,115 × 15</span></span>
<span><span class="co">#&gt;   origin  year month   day  hour  temp  dewp humid wind_dir</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 EWR     2013     1     1     1  39.0  26.1  59.4      270</span></span>
<span><span class="co">#&gt; 2 EWR     2013     1     1     2  39.0  27.0  61.6      250</span></span>
<span><span class="co">#&gt; 3 EWR     2013     1     1     3  39.0  28.0  64.4      240</span></span>
<span><span class="co">#&gt; 4 EWR     2013     1     1     4  39.9  28.0  62.2      250</span></span>
<span><span class="co">#&gt; 5 EWR     2013     1     1     5  39.0  28.0  64.4      260</span></span>
<span><span class="co">#&gt; 6 EWR     2013     1     1     6  37.9  28.0  67.2      240</span></span>
<span><span class="co">#&gt; # ℹ 26,109 more rows</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: wind_speed &lt;dbl&gt;, wind_gust &lt;dbl&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ul>
<p><strong>外键 (foreign key)</strong> 是一个（或一组）与另一个表中的主键相对应的变量。例如：</p>
<ul>
<li>
<code>flights$tailnum</code> 是一个外键，对应于主键 <code>planes$tailnum</code>。</li>
<li>
<code>flights$carrier</code> 是一个外键，对应于主键 <code>airlines$carrier</code>。</li>
<li>
<code>flights$origin</code> 是一个外键，对应于主键 <code>airports$faa</code>。</li>
<li>
<code>flights$dest</code> 是一个外键，对应于主键 <code>airports$faa</code>。</li>
<li>
<code>flights$origin</code>-<code>flights$time_hour</code> 是一个复合外键，对应于复合主键 <code>weather$origin</code>-<code>weather$time_hour</code>。</li>
</ul>
<p>这些关系在 <a href="#fig-flights-relationships" class="quarto-xref">Figure&nbsp;<span>19.1</span></a> 中进行了可视化总结。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-flights-relationships" class="quarto-float quarto-figure quarto-figure-center anchored" alt="nycflights13 包中 airports、planes、flights、weather 和 airlines 数据集之间的关系。airports$faa 连接到 flights$origin 和 flights$dest。planes$tailnum 连接到 flights$tailnum。weather$time_hour 和 weather$origin 联合连接到 flights$time_hour 和 flights$origin。airlines$carrier 连接到 flights$carrier。airports、planes、airlines 和 weather 数据框之间没有直接连接。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-flights-relationships-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/relational.png" class="img-fluid figure-img" alt="nycflights13 包中 airports、planes、flights、weather 和 airlines 数据集之间的关系。airports$faa 连接到 flights$origin 和 flights$dest。planes$tailnum 连接到 flights$tailnum。weather$time_hour 和 weather$origin 联合连接到 flights$time_hour 和 flights$origin。airlines$carrier 连接到 flights$carrier。airports、planes、airlines 和 weather 数据框之间没有直接连接。" width="502">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-flights-relationships-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.1: nycflights13 包中所有五个数据框之间的连接。构成主键的变量用灰色着色，并通过箭头连接到它们对应的外键。
</figcaption></figure>
</div>
</div>
</div>
<p>你会注意到这些键的设计中有一个很好的特性：主键和外键几乎总是有相同的名称，正如你稍后将看到的，这将使你的连接工作变得容易得多。同样值得注意的是相反的关系：几乎每个在多个表中使用的变量名在每个地方都有相同的含义。只有一个例外：在 <code>flights</code> 中 <code>year</code> 表示出发年份，在 <code>planes</code> 中表示制造年份。当我们开始实际连接表时，这将变得很重要。</p>
</section><section id="检查主键" class="level3" data-number="19.2.2"><h3 data-number="19.2.2" class="anchored" data-anchor-id="检查主键">
<span class="header-section-number">19.2.2</span> 检查主键</h3>
<p>既然我们已经确定了每个表中的主键，一个好的做法是验证它们确实唯一地标识了每个观测值。一种方法是 <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code> 主键，并查找 <code>n</code> 大于 1 的条目。这表明 <code>planes</code> 和 <code>weather</code> 都看起来不错：</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">planes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 2</span></span>
<span><span class="co">#&gt; # ℹ 2 variables: tailnum &lt;chr&gt;, n &lt;int&gt;</span></span>
<span></span>
<span><span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">time_hour</span>, <span class="va">origin</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 3</span></span>
<span><span class="co">#&gt; # ℹ 3 variables: time_hour &lt;dttm&gt;, origin &lt;chr&gt;, n &lt;int&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>你还应该检查主键中是否有缺失值——如果一个值是缺失的，那么它就不能标识一个观测值！</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">planes</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 9</span></span>
<span><span class="co">#&gt; # ℹ 9 variables: tailnum &lt;chr&gt;, year &lt;int&gt;, type &lt;chr&gt;, manufacturer &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   model &lt;chr&gt;, engines &lt;int&gt;, seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;</span></span>
<span></span>
<span><span class="va">weather</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">time_hour</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">origin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 15</span></span>
<span><span class="co">#&gt; # ℹ 15 variables: origin &lt;chr&gt;, year &lt;int&gt;, month &lt;int&gt;, day &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   hour &lt;int&gt;, temp &lt;dbl&gt;, dewp &lt;dbl&gt;, humid &lt;dbl&gt;, wind_dir &lt;dbl&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="代理键" class="level3" data-number="19.2.3"><h3 data-number="19.2.3" class="anchored" data-anchor-id="代理键">
<span class="header-section-number">19.2.3</span> 代理键</h3>
<p>到目前为止，我们还没有讨论 <code>flights</code> 的主键。它在这里不是非常重要，因为没有数据框使用它作为外键，但考虑它仍然是有用的，因为如果我们有某种方式向他人描述观测值，那么处理观测值会更容易。</p>
<p>经过一番思考和实验，我们确定有三个变量可以共同唯一地标识每个航班：</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">time_hour</span>, <span class="va">carrier</span>, <span class="va">flight</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 4</span></span>
<span><span class="co">#&gt; # ℹ 4 variables: time_hour &lt;dttm&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, n &lt;int&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>没有重复值是否自动使 <code>time_hour</code>-<code>carrier</code>-<code>flight</code> 成为一个主键？这当然是一个好的开始，但并不能保证它。例如，海拔和纬度是 <code>airports</code> 的一个好的主键吗？</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">alt</span>, <span class="va">lat</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;     alt   lat     n</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1    13  40.6     2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>通过海拔和纬度来识别一个机场显然是一个坏主意，而且总的来说，仅从数据本身不可能知道一个变量组合是否构成一个好的主键。但对于航班来说，<code>time_hour</code>、<code>carrier</code> 和 <code>flight</code> 的组合似乎是合理的，因为如果同一时间同一家航空公司有多个相同航班号的航班在空中，那对航空公司及其客户来说会非常混乱。</p>
<p>话虽如此，我们最好还是引入一个简单的数字代理键，使用行号：</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">flights2</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 20</span></span>
<span><span class="co">#&gt;      id  year month   day dep_time sched_dep_time dep_delay arr_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1     1  2013     1     1      517            515         2      830</span></span>
<span><span class="co">#&gt; 2     2  2013     1     1      533            529         4      850</span></span>
<span><span class="co">#&gt; 3     3  2013     1     1      542            540         2      923</span></span>
<span><span class="co">#&gt; 4     4  2013     1     1      544            545        -1     1004</span></span>
<span><span class="co">#&gt; 5     5  2013     1     1      554            600        -6      812</span></span>
<span><span class="co">#&gt; 6     6  2013     1     1      554            558        -4      740</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 12 more variables: sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>代理键在与他人交流时特别有用：告诉某人查看航班 2001 比告诉他们查看 2013 年 1 月 3 日上午 9 点出发的 UA430 要容易得多。</p>
</section><section id="练习" class="level3" data-number="19.2.4"><h3 data-number="19.2.4" class="anchored" data-anchor-id="练习">
<span class="header-section-number">19.2.4</span> 练习</h3>
<ol type="1">
<li><p>我们在 <a href="#fig-flights-relationships" class="quarto-xref">Figure&nbsp;<span>19.1</span></a> 中忘记绘制 <code>weather</code> 和 <code>airports</code> 之间的关系了。这个关系是什么？它应该如何在图中显示？</p></li>
<li><p><code>weather</code> 只包含纽约市三个始发机场的信息。如果它包含了美国所有机场的天气记录，它会与 <code>flights</code> 建立什么额外的连接？</p></li>
<li><p><code>year</code>、<code>month</code>、<code>day</code>、<code>hour</code> 和 <code>origin</code> 变量几乎构成了 <code>weather</code> 的一个复合键，但有一个小时有重复的观测值。你能找出那个小时有什么特别之处吗？</p></li>
<li><p>我们知道一年中的某些日子是特殊的，飞行的人比平时少（例如，平安夜和圣诞节）。你如何将这些数据表示为一个数据框？主键会是什么？它将如何与现有的数据框连接？</p></li>
<li><p>在 Lahman 包中，绘制一个图表来说明 <code>Batting</code>、<code>People</code> 和 <code>Salaries</code> 数据框之间的连接。再绘制一个图表来显示 <code>People</code>、<code>Managers</code> 和 <code>AwardsManagers</code> 之间的关系。你将如何描述 <code>Batting</code>、<code>Pitching</code> 和 <code>Fielding</code> 数据框之间的关系？</p></li>
</ol></section></section><section id="sec-mutating-joins" class="level2" data-number="19.3"><h2 data-number="19.3" class="anchored" data-anchor-id="sec-mutating-joins">
<span class="header-section-number">19.3</span> 基本连接</h2>
<p>既然你已经了解了数据框如何通过键连接，我们就可以开始使用连接来更好地理解 <code>flights</code> 数据集了。dplyr 提供了六个连接函数：<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join()</a></code>。它们都有相同的接口：它们接受一对数据框（<code>x</code> 和 <code>y</code>），并返回一个数据框。输出的行和列的顺序主要由 <code>x</code> 决定。</p>
<p>在本节中，你将学习如何使用一个变连接 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> 和两个过滤连接 <code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join()</a></code>。在下一节中，你将确切地学习这些函数如何工作，以及剩下的 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code> 和 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code>。</p>
<section id="变连接" class="level3" data-number="19.3.1"><h3 data-number="19.3.1" class="anchored" data-anchor-id="变连接">
<span class="header-section-number">19.3.1</span> 变连接</h3>
<p><strong>变连接 (mutating join)</strong> 允许你组合两个数据框中的变量：它首先通过它们的键来匹配观测值，然后将一个数据框中的变量复制到另一个数据框中。像 <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 一样，连接函数在右侧添加变量，所以如果你的数据集有很多变量，你将看不到新的变量。对于这些例子，我们将通过创建一个只有六个变量的较窄的数据集来使其更容易看清发生了什么<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>：</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">time_hour</span>, <span class="va">origin</span>, <span class="va">dest</span>, <span class="va">tailnum</span>, <span class="va">carrier</span><span class="op">)</span></span>
<span><span class="va">flights2</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 6</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA     </span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA     </span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA     </span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6     </span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL     </span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA     </span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>有四种类型的变连接，但有一种你几乎总是会使用：<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>。它很特别，因为输出将始终与 <code>x</code>（你正在连接的数据框）具有相同的行<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> 的主要用途是添加额外的元数据。例如，我们可以使用 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> 将完整的航空公司名称添加到 <code>flights2</code> 数据中：</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">airlines</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(carrier)`</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 7</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier name                </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      United Air Lines In…</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      United Air Lines In…</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      American Airlines I…</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      JetBlue Airways     </span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      Delta Air Lines Inc.</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      United Air Lines In…</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者我们可以找出每架飞机起飞时的温度和风速：</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">weather</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">origin</span>, <span class="va">time_hour</span>, <span class="va">temp</span>, <span class="va">wind_speed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(time_hour, origin)`</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 8</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier  temp wind_speed</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA       39.0       12.7</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA       39.9       15.0</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA       39.0       15.0</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6       39.0       15.0</span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL       39.9       16.1</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA       39.0       12.7</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者是什么尺寸的飞机在飞行：</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">planes</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">tailnum</span>, <span class="va">type</span>, <span class="va">engines</span>, <span class="va">seats</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(tailnum)`</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 9</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier type                </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      Fixed wing multi en…</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 2 more variables: engines &lt;int&gt;, seats &lt;int&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>当 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> 未能为 <code>x</code> 中的某一行找到匹配项时，它会用缺失值填充新变量。例如，没有关于尾号为 <code>N3ALAA</code> 的飞机的信息，所以 <code>type</code>、<code>engines</code> 和 <code>seats</code> 将是缺失的：</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">tailnum</span> <span class="op">==</span> <span class="st">"N3ALAA"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">planes</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">tailnum</span>, <span class="va">type</span>, <span class="va">engines</span>, <span class="va">seats</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(tailnum)`</span></span>
<span><span class="co">#&gt; # A tibble: 63 × 9</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier type  engines seats</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 06:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-02 18:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-03 06:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-07 19:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 5  2013 2013-01-08 17:00:00 JFK    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-16 06:00:00 LGA    ORD   N3ALAA  AA      &lt;NA&gt;       NA    NA</span></span>
<span><span class="co">#&gt; # ℹ 57 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>我们将在本章的其余部分几次回到这个问题。</p>
</section><section id="指定连接键" class="level3" data-number="19.3.2"><h3 data-number="19.3.2" class="anchored" data-anchor-id="指定连接键">
<span class="header-section-number">19.3.2</span> 指定连接键</h3>
<p>默认情况下，<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> 将使用同时出现在两个数据框中的所有变量作为连接键，这被称为<strong>自然 (natural)</strong> 连接。这是一个有用的启发式方法，但它并不总是有效。例如，如果我们尝试将 <code>flights2</code> 与完整的 <code>planes</code> 数据集连接会发生什么？</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">planes</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(year, tailnum)`</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 13</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier type  manufacturer</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;       </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      &lt;NA&gt;  &lt;NA&gt;        </span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 5 more variables: model &lt;chr&gt;, engines &lt;int&gt;, seats &lt;int&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>我们得到了很多缺失的匹配，因为我们的连接正在尝试使用 <code>tailnum</code> 和 <code>year</code> 作为复合键。<code>flights</code> 和 <code>planes</code> 都有一个 <code>year</code> 列，但它们的含义不同：<code>flights$year</code> 是航班发生的年份，而 <code>planes$year</code> 是飞机制造的年份。我们只想在 <code>tailnum</code>上连接，所以我们需要使用 <code><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by()</a></code> 提供一个明确的规范：</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">planes</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 14</span></span>
<span><span class="co">#&gt;   year.x time_hour           origin dest  tailnum carrier year.y</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1   2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA        1999</span></span>
<span><span class="co">#&gt; 2   2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA        1998</span></span>
<span><span class="co">#&gt; 3   2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA        1990</span></span>
<span><span class="co">#&gt; 4   2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6        2012</span></span>
<span><span class="co">#&gt; 5   2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL        1991</span></span>
<span><span class="co">#&gt; 6   2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA        2012</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 7 more variables: type &lt;chr&gt;, manufacturer &lt;chr&gt;, model &lt;chr&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>请注意，<code>year</code> 变量在输出中通过后缀（<code>year.x</code> 和 <code>year.y</code>）进行了区分，这告诉你变量是来自 <code>x</code> 参数还是 <code>y</code> 参数。你可以使用 <code>suffix</code> 参数覆盖默认的后缀。</p>
<p><code>join_by(tailnum)</code> 是 <code>join_by(tailnum == tailnum)</code> 的简写。了解这种更完整的形式很重要，原因有二。首先，它描述了两个表之间的关系：键必须相等。这就是为什么这种类型的连接通常被称为<strong>等值连接 (equi join)</strong>。你将在 <a href="#sec-non-equi-joins" class="quarto-xref"><span>Section 19.5</span></a> 中学习非等值连接。</p>
<p>其次，这是你在每个表中指定不同连接键的方式。例如，有两种方法可以连接 <code>flight2</code> 和 <code>airports</code> 表：通过 <code>dest</code> 或 <code>origin</code>：</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 13</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier name                </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;               </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      George Bush Interco…</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      George Bush Interco…</span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      Miami Intl          </span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      &lt;NA&gt;                </span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      Hartsfield Jackson …</span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      Chicago Ohare Intl  </span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: lat &lt;dbl&gt;, lon &lt;dbl&gt;, alt &lt;dbl&gt;, tz &lt;dbl&gt;, …</span></span>
<span></span>
<span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">origin</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 13</span></span>
<span><span class="co">#&gt;    year time_hour           origin dest  tailnum carrier name               </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;              </span></span>
<span><span class="co">#&gt; 1  2013 2013-01-01 05:00:00 EWR    IAH   N14228  UA      Newark Liberty Intl</span></span>
<span><span class="co">#&gt; 2  2013 2013-01-01 05:00:00 LGA    IAH   N24211  UA      La Guardia         </span></span>
<span><span class="co">#&gt; 3  2013 2013-01-01 05:00:00 JFK    MIA   N619AA  AA      John F Kennedy Intl</span></span>
<span><span class="co">#&gt; 4  2013 2013-01-01 05:00:00 JFK    BQN   N804JB  B6      John F Kennedy Intl</span></span>
<span><span class="co">#&gt; 5  2013 2013-01-01 06:00:00 LGA    ATL   N668DN  DL      La Guardia         </span></span>
<span><span class="co">#&gt; 6  2013 2013-01-01 05:00:00 EWR    ORD   N39463  UA      Newark Liberty Intl</span></span>
<span><span class="co">#&gt; # ℹ 336,770 more rows</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: lat &lt;dbl&gt;, lon &lt;dbl&gt;, alt &lt;dbl&gt;, tz &lt;dbl&gt;, …</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在旧代码中，你可能会看到一种不同的指定连接键的方式，使用一个字符向量：</p>
<ul>
<li>
<code>by = "x"</code> 对应于 <code>join_by(x)</code>。</li>
<li>
<code>by = c("a" = "x")</code> 对应于 <code>join_by(a == x)</code>。</li>
</ul>
<p>既然 <code><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by()</a></code> 已经存在，我们更喜欢使用它，因为它提供了更清晰和更灵活的规范。</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code> 的接口与 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> 相同。区别在于它们保留哪些行：左连接保留 <code>x</code> 中的所有行，右连接保留 <code>y</code> 中的所有行，全连接保留 <code>x</code> 或 <code>y</code> 中的所有行，而内连接只保留同时出现在 <code>x</code> 和 <code>y</code> 中的行。我们稍后会更详细地回到这些。</p>
</section><section id="过滤连接" class="level3" data-number="19.3.3"><h3 data-number="19.3.3" class="anchored" data-anchor-id="过滤连接">
<span class="header-section-number">19.3.3</span> 过滤连接</h3>
<p>你可能猜到，<strong>过滤连接 (filtering join)</strong> 的主要作用是过滤行。有两种类型：半连接 (semi-joins) 和反连接 (anti-joins)。 <strong>半连接</strong>保留 <code>x</code> 中所有在 <code>y</code> 中有匹配的行。例如，我们可以使用半连接来过滤 <code>airports</code> 数据集，只显示始发机场：</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">flights2</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">faa</span> <span class="op">==</span> <span class="va">origin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 8</span></span>
<span><span class="co">#&gt;   faa   name                  lat   lon   alt    tz dst   tzone           </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;               &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;           </span></span>
<span><span class="co">#&gt; 1 EWR   Newark Liberty Intl  40.7 -74.2    18    -5 A     America/New_York</span></span>
<span><span class="co">#&gt; 2 JFK   John F Kennedy Intl  40.6 -73.8    13    -5 A     America/New_York</span></span>
<span><span class="co">#&gt; 3 LGA   La Guardia           40.8 -73.9    22    -5 A     America/New_York</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者只显示目的地：</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">flights2</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">faa</span> <span class="op">==</span> <span class="va">dest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 101 × 8</span></span>
<span><span class="co">#&gt;   faa   name                     lat    lon   alt    tz dst   tzone          </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;                  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;          </span></span>
<span><span class="co">#&gt; 1 ABQ   Albuquerque Internati…  35.0 -107.   5355    -7 A     America/Denver </span></span>
<span><span class="co">#&gt; 2 ACK   Nantucket Mem           41.3  -70.1    48    -5 A     America/New_Yo…</span></span>
<span><span class="co">#&gt; 3 ALB   Albany Intl             42.7  -73.8   285    -5 A     America/New_Yo…</span></span>
<span><span class="co">#&gt; 4 ANC   Ted Stevens Anchorage…  61.2 -150.    152    -9 A     America/Anchor…</span></span>
<span><span class="co">#&gt; 5 ATL   Hartsfield Jackson At…  33.6  -84.4  1026    -5 A     America/New_Yo…</span></span>
<span><span class="co">#&gt; 6 AUS   Austin Bergstrom Intl   30.2  -97.7   542    -6 A     America/Chicago</span></span>
<span><span class="co">#&gt; # ℹ 95 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>反连接</strong>则相反：它们返回 <code>x</code> 中所有在 <code>y</code> 中没有匹配的行。它们对于查找数据中<strong>隐式</strong>的缺失值很有用，这是 <a href="missing-values.html#sec-missing-implicit" class="quarto-xref"><span>Section 18.3</span></a> 的主题。隐式缺失值不会显示为 <code>NA</code>，而是仅仅以缺席的形式存在。例如，我们可以通过查找没有匹配目的地机场的航班来找到 <code>airports</code> 中缺失的行：</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">dest</span> <span class="op">==</span> <span class="va">faa</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 1</span></span>
<span><span class="co">#&gt;   dest </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 BQN  </span></span>
<span><span class="co">#&gt; 2 SJU  </span></span>
<span><span class="co">#&gt; 3 STT  </span></span>
<span><span class="co">#&gt; 4 PSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>或者我们可以找出哪些 <code>tailnum</code> 在 <code>planes</code> 中是缺失的：</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">planes</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 722 × 1</span></span>
<span><span class="co">#&gt;   tailnum</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1 N3ALAA </span></span>
<span><span class="co">#&gt; 2 N3DUAA </span></span>
<span><span class="co">#&gt; 3 N542MQ </span></span>
<span><span class="co">#&gt; 4 N730MQ </span></span>
<span><span class="co">#&gt; 5 N9EAMQ </span></span>
<span><span class="co">#&gt; 6 N532UA </span></span>
<span><span class="co">#&gt; # ℹ 716 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="练习-1" class="level3" data-number="19.3.4"><h3 data-number="19.3.4" class="anchored" data-anchor-id="练习-1">
<span class="header-section-number">19.3.4</span> 练习</h3>
<ol type="1">
<li><p>找出（全年）延误最严重的 48 个小时。与 <code>weather</code> 数据进行交叉引用。你能看到任何模式吗？</p></li>
<li>
<p>想象你已经用这段代码找到了排名前 10 的最受欢迎的目的地：</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">top_dest</span> <span class="op">&lt;-</span> <span class="va">flights2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">dest</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>你如何找到所有飞往这些目的地的航班？</p>
</li>
<li><p>每个出发的航班都有对应那个小时的天气数据吗？</p></li>
<li><p>那些在 <code>planes</code> 中没有匹配记录的尾号有什么共同点？（提示：一个变量解释了约 90% 的问题。）</p></li>
<li><p>向 <code>planes</code> 添加一列，列出飞过那架飞机的每个 <code>carrier</code>。你可能期望飞机和航空公司之间存在一种隐式关系，因为每架飞机都由一家航空公司运营。使用你在前面章节中学到的工具来证实或否定这个假设。</p></li>
<li><p>将始发地<em>和</em>目的地机场的纬度和经度添加到 <code>flights</code> 中。是在连接之前还是之后重命名列更容易？</p></li>
<li>
<p>按目的地计算平均延误，然后与 <code>airports</code> 数据框连接，这样你就可以显示延误的空间分布。这里有一个绘制美国地图的简单方法：</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airports</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">faa</span> <span class="op">==</span> <span class="va">dest</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lon</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/borders.html">borders</a></span><span class="op">(</span><span class="st">"state"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_map.html">coord_quickmap</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>你可能想用点的大小或颜色来显示每个机场的平均延误。</p>
</li>
<li><p>2013 年 6 月 13 日发生了什么？绘制一张延误地图，然后用谷歌与天气进行交叉引用。</p></li>
</ol></section></section><section id="连接如何工作" class="level2" data-number="19.4"><h2 data-number="19.4" class="anchored" data-anchor-id="连接如何工作">
<span class="header-section-number">19.4</span> 连接如何工作？</h2>
<p>既然你已经使用过几次连接了，是时候学习更多关于它们如何工作的知识了，重点是 <code>x</code> 中的每一行如何与 <code>y</code> 中的行匹配。我们将首先介绍一种连接的可视化表示法，使用下面定义的简单 tibble，并如 <a href="#fig-join-setup" class="quarto-xref">Figure&nbsp;<span>19.2</span></a> 所示。在这些例子中，我们将使用一个名为 <code>key</code> 的单个键和一个单个值列（<code>val_x</code> 和 <code>val_y</code>），但这些思想都适用于多个键和多个值。</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_x</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"x1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"x2"</span>,</span>
<span>     <span class="fl">3</span>, <span class="st">"x3"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_y</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"y1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"y2"</span>,</span>
<span>     <span class="fl">4</span>, <span class="st">"y3"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-setup" class="quarto-float quarto-figure quarto-figure-center anchored" alt="x 和 y 是两个数据框，各有 2 列 3 行，内容如文中所述。键的值被着色：1 是绿色，2 是紫色，3 是橙色，4 是黄色。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-setup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/setup.png" class="img-fluid figure-img" alt="x 和 y 是两个数据框，各有 2 列 3 行，内容如文中所述。键的值被着色：1 是绿色，2 是紫色，3 是橙色，4 是黄色。" width="160">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-setup-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.2: 两个简单表格的图形表示。带颜色的 <code>key</code> 列将背景色映射到键值。灰色列代表被“携带”的值列。
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-join-setup2" class="quarto-xref">Figure&nbsp;<span>19.3</span></a> 介绍了我们可视化表示法的基础。它将 <code>x</code> 和 <code>y</code> 之间的所有潜在匹配显示为从 <code>x</code> 的每一行和 <code>y</code> 的每一行画出的线的交点。输出中的行和列主要由 <code>x</code> 决定，所以 <code>x</code> 表是水平的，并与输出对齐。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-setup2" class="quarto-float quarto-figure quarto-figure-center anchored" alt="x 和 y 被放置成直角，水平线从 x 延伸，垂直线从 y 延伸。x 中有 3 行，y 中有 3 行，这导致了九个交点，代表九个潜在的匹配。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-setup2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/setup2.png" class="img-fluid figure-img" alt="x 和 y 被放置成直角，水平线从 x 延伸，垂直线从 y 延伸。x 中有 3 行，y 中有 3 行，这导致了九个交点，代表九个潜在的匹配。" width="170">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-setup2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.3: 要理解连接如何工作，将每种可能的匹配都考虑进去是很有用的。这里我们用一个连接线的网格来展示这一点。
</figcaption></figure>
</div>
</div>
</div>
<p>为了描述一种特定类型的连接，我们用点来表示匹配。匹配决定了输出中的行，这是一个新的数据框，包含键、x 值和 y 值。例如，<a href="#fig-join-inner" class="quarto-xref">Figure&nbsp;<span>19.4</span></a> 展示了一个内连接，当且仅当键相等时，行才被保留。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-inner" class="quarto-float quarto-figure quarto-figure-center anchored" alt="x 和 y 被放置成直角，线形成一个潜在匹配的网格。键 1 和 2 同时出现在 x 和 y 中，所以我们得到了匹配，用一个点表示。每个点对应输出中的一行，所以最终的连接数据框有两行。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-inner-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/inner.png" class="img-fluid figure-img" alt="x 和 y 被放置成直角，线形成一个潜在匹配的网格。键 1 和 2 同时出现在 x 和 y 中，所以我们得到了匹配，用一个点表示。每个点对应输出中的一行，所以最终的连接数据框有两行。" width="363">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-inner-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.4: 内连接将 <code>x</code> 中的每一行与 <code>y</code> 中具有相同 <code>key</code> 值的行进行匹配。每个匹配都成为输出中的一行。
</figcaption></figure>
</div>
</div>
</div>
<p>我们可以应用相同的原则来解释<strong>外连接 (outer joins)</strong>，它保留出现在至少一个数据框中的观测值。这些连接通过向每个数据框添加一个额外的“虚拟”观测值来工作。这个观测值有一个在没有其他键匹配时能够匹配的键，并且值用 <code>NA</code> 填充。有三种类型的外连接：</p>
<ul>
<li>
<p><strong>左连接 (left join)</strong> 保留 <code>x</code> 中的所有观测值，<a href="#fig-join-left" class="quarto-xref">Figure&nbsp;<span>19.5</span></a>。<code>x</code> 的每一行都在输出中被保留，因为它可以回退到匹配 <code>y</code> 中的一行 <code>NA</code>。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-left" class="quarto-float quarto-figure quarto-figure-center anchored" alt="与之前显示内连接的图相比，y 表现在多了一个包含 NA 的虚拟行，它将匹配任何在 x 中没有其他匹配的行。这意味着输出现在有三行。对于 key = 3，它匹配这个虚拟行，val_y 的值为 NA。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-left-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/left.png" class="img-fluid figure-img" alt="与之前显示内连接的图相比，y 表现在多了一个包含 NA 的虚拟行，它将匹配任何在 x 中没有其他匹配的行。这意味着输出现在有三行。对于 key = 3，它匹配这个虚拟行，val_y 的值为 NA。" width="385">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-left-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.5: 左连接的可视化表示，其中 <code>x</code> 中的每一行都出现在输出中。
</figcaption></figure>
</div>
</div>
</div>
</li>
<li>
<p><strong>右连接 (right join)</strong> 保留 <code>y</code> 中的所有观测值，<a href="#fig-join-right" class="quarto-xref">Figure&nbsp;<span>19.6</span></a>。<code>y</code> 的每一行都在输出中被保留，因为它可以回退到匹配 <code>x</code> 中的一行 <code>NA</code>。输出仍然尽可能地与 <code>x</code> 匹配；来自 <code>y</code> 的任何多余的行都被添加到末尾。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-right" class="quarto-float quarto-figure quarto-figure-center anchored" alt="与之前显示左连接的图相比，x 表现在增加了一个虚拟行，以便 y 中的每一行都能在 x 中找到匹配。对于 y 中没有匹配 x 的行，val_x 包含 NA。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-right-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/right.png" class="img-fluid figure-img" alt="与之前显示左连接的图相比，x 表现在增加了一个虚拟行，以便 y 中的每一行都能在 x 中找到匹配。对于 y 中没有匹配 x 的行，val_x 包含 NA。" width="380">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-right-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.6: 右连接的可视化表示，其中 <code>y</code> 的每一行都出现在输出中。
</figcaption></figure>
</div>
</div>
</div>
</li>
<li>
<p><strong>全连接 (full join)</strong> 保留出现在 <code>x</code> 或 <code>y</code> 中的所有观测值，<a href="#fig-join-full" class="quarto-xref">Figure&nbsp;<span>19.7</span></a>。<code>x</code> 和 <code>y</code> 的每一行都包含在输出中，因为 <code>x</code> 和 <code>y</code> 都有一个回退的 <code>NA</code> 行。同样，输出以 <code>x</code> 的所有行开始，然后是剩余的未匹配的 <code>y</code> 行。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-full" class="quarto-float quarto-figure quarto-figure-center anchored" alt="现在 x 和 y 都有一个总是匹配的虚拟行。结果有 4 行：键 1、2、3 和 4，以及来自 val_x 和 val_y 的所有值，然而键 2 的 val_y 和键 4 的 val_x 是 NA，因为这些键在其他数据框中没有匹配。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-full-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/full.png" class="img-fluid figure-img" alt="现在 x 和 y 都有一个总是匹配的虚拟行。结果有 4 行：键 1、2、3 和 4，以及来自 val_x 和 val_y 的所有值，然而键 2 的 val_y 和键 4 的 val_x 是 NA，因为这些键在其他数据框中没有匹配。" width="388">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-full-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.7: 全连接的可视化表示，其中 <code>x</code> 和 <code>y</code> 中的每一行都出现在输出中。
</figcaption></figure>
</div>
</div>
</div>
</li>
</ul>
<p>另一种显示外连接类型差异的方法是使用维恩图，如 <a href="#fig-join-venn" class="quarto-xref">Figure&nbsp;<span>19.8</span></a> 所示。然而，这不是一个很好的表示方法，因为尽管它可能会让你记起哪些行被保留了，但它未能说明列发生了什么。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-venn" class="quarto-float quarto-figure quarto-figure-center anchored" alt="内连接、全连接、左连接和右连接的维恩图。每个连接由两个相交的圆表示，代表数据框 x 和 y，x 在右边，y 在左边。阴影表示连接的结果。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-venn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/venn.png" class="img-fluid figure-img" alt="内连接、全连接、左连接和右连接的维恩图。每个连接由两个相交的圆表示，代表数据框 x 和 y，x 在右边，y 在左边。阴影表示连接的结果。" width="385">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-venn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.8: 维恩图显示内连接、左连接、右连接和全连接之间的差异。
</figcaption></figure>
</div>
</div>
</div>
<p>这里显示的连接是所谓的<strong>等值 (equi)</strong> 连接，其中如果键相等则行匹配。等值连接是最常见的连接类型，所以我们通常会省略等值前缀，只说“内连接”而不是“等值内连接”。我们将在 <a href="#sec-non-equi-joins" class="quarto-xref"><span>Section 19.5</span></a> 中回到非等值连接。</p>
<section id="行匹配" class="level3" data-number="19.4.1"><h3 data-number="19.4.1" class="anchored" data-anchor-id="行匹配">
<span class="header-section-number">19.4.1</span> 行匹配</h3>
<p>到目前为止，我们已经探讨了如果 <code>x</code> 中的一行与 <code>y</code> 中的零行或一行匹配会发生什么。如果它匹配多于一行会发生什么？要理解发生了什么，让我们首先将焦点缩小到 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>，然后画一幅图，<a href="#fig-join-match-types" class="quarto-xref">Figure&nbsp;<span>19.9</span></a>。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-match-types" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个连接图，其中 x 的键值为 1、2 和 3，y 的键值为 1、2、2。输出有三行，因为键 1 匹配一行，键 2 匹配两行，键 3 匹配零行。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-match-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/match-types.png" class="img-fluid figure-img" alt="一个连接图，其中 x 的键值为 1、2 和 3，y 的键值为 1、2、2。输出有三行，因为键 1 匹配一行，键 2 匹配两行，键 3 匹配零行。" width="348">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-match-types-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.9: <code>x</code> 中的一行可以有三种匹配方式。<code>x1</code> 匹配 <code>y</code> 中的一行，<code>x2</code> 匹配 <code>y</code> 中的两行，<code>x3</code> 匹配 <code>y</code> 中的零行。注意，虽然 <code>x</code> 中有三行，输出中也有三行，但这些行之间没有直接的对应关系。
</figcaption></figure>
</div>
</div>
</div>
<p><code>x</code> 中的一行有三种可能的结果：</p>
<ul>
<li>如果它不匹配任何东西，它就会被丢弃。</li>
<li>如果它匹配 <code>y</code> 中的 1 行，它就会被保留。</li>
<li>如果它匹配 <code>y</code> 中的多于 1 行，它会为每个匹配复制一次。</li>
</ul>
<p>原则上，这意味着输出中的行与 <code>x</code> 中的行之间没有保证的对应关系，但在实践中，这很少引起问题。然而，有一个特别危险的情况可能会导致行的组合爆炸。想象一下连接以下两个表：</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, val_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, val_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y1"</span>, <span class="st">"y2"</span>, <span class="st">"y3"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>虽然 <code>df1</code> 中的第一行只匹配 <code>df2</code> 中的一行，但第二行和第三行都匹配两行。这有时被称为<code>多对多 (many-to-many)</code>连接，并且会导致 dplyr 发出警告：</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">df2</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">key</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in inner_join(df1, df2, join_by(key)): Detected an unexpected many-to-many relationship between `x` and `y`.</span></span>
<span><span class="co">#&gt; ℹ Row 2 of `x` matches multiple rows in `y`.</span></span>
<span><span class="co">#&gt; ℹ Row 2 of `y` matches multiple rows in `x`.</span></span>
<span><span class="co">#&gt; ℹ If a many-to-many relationship is expected, set `relationship =</span></span>
<span><span class="co">#&gt;   "many-to-many"` to silence this warning.</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 3</span></span>
<span><span class="co">#&gt;     key val_x val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1    y1   </span></span>
<span><span class="co">#&gt; 2     2 x2    y2   </span></span>
<span><span class="co">#&gt; 3     2 x2    y3   </span></span>
<span><span class="co">#&gt; 4     2 x3    y2   </span></span>
<span><span class="co">#&gt; 5     2 x3    y3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果你是故意这样做的，你可以设置 <code>relationship = "many-to-many"</code>，正如警告所建议的那样。</p>
</section><section id="过滤连接-1" class="level3" data-number="19.4.2"><h3 data-number="19.4.2" class="anchored" data-anchor-id="过滤连接-1">
<span class="header-section-number">19.4.2</span> 过滤连接</h3>
<p>匹配的数量也决定了过滤连接的行为。半连接保留 <code>x</code> 中在 <code>y</code> 中有一个或多个匹配的行，如 <a href="#fig-join-semi" class="quarto-xref">Figure&nbsp;<span>19.10</span></a> 所示。反连接保留 <code>x</code> 中匹配 <code>y</code> 中零行的行，如 <a href="#fig-join-anti" class="quarto-xref">Figure&nbsp;<span>19.11</span></a> 所示。在这两种情况下，只有匹配的存在是重要的；它匹配多少次并不重要。这意味着过滤连接从不像变连接那样复制行。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-semi" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个连接图，其中有老朋友 x 和 y。在半连接中，只有匹配的存在才重要，所以输出包含与 x 相同的列。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-semi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/semi.png" class="img-fluid figure-img" alt="一个连接图，其中有老朋友 x 和 y。在半连接中，只有匹配的存在才重要，所以输出包含与 x 相同的列。" width="318">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-semi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.10: 在半连接中，重要的是存在匹配；否则 <code>y</code> 中的值不会影响输出。
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-anti" class="quarto-float quarto-figure quarto-figure-center anchored" alt="反连接是半连接的逆操作，所以匹配用红线画出，表示它们将从输出中被删除。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-anti-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/anti.png" class="img-fluid figure-img" alt="反连接是半连接的逆操作，所以匹配用红线画出，表示它们将从输出中被删除。" width="317">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-anti-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.11: 反连接是半连接的逆操作，从 <code>x</code> 中删除在 <code>y</code> 中有匹配的行。
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="sec-non-equi-joins" class="level2" data-number="19.5"><h2 data-number="19.5" class="anchored" data-anchor-id="sec-non-equi-joins">
<span class="header-section-number">19.5</span> 非等值连接</h2>
<p>到目前为止，你只看到了等值连接，即如果 <code>x</code> 键等于 <code>y</code> 键，行就匹配。现在我们将放宽这个限制，讨论确定一对行是否匹配的其他方法。</p>
<p>但在此之前，我们需要重新审视我们上面做的一个简化。在等值连接中，<code>x</code> 键和 <code>y</code> 键总是相等的，所以我们只需要在输出中显示一个。我们可以通过 <code>keep = TRUE</code> 来请求 dplyr 保留两个键，这导致了下面的代码和 <a href="#fig-inner-both" class="quarto-xref">Figure&nbsp;<span>19.12</span></a> 中重新绘制的 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code>。</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">key</span> <span class="op">==</span> <span class="va">key</span><span class="op">)</span>, keep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   key.x val_x key.y val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1        1 y1   </span></span>
<span><span class="co">#&gt; 2     2 x2        2 y2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-inner-both" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个显示 x 和 y 之间内连接的连接图。结果现在包括四列：key.x、val_x、key.y 和 val_y。key.x 和 key.y 的值是相同的，这就是为什么我们通常只显示一个。 ">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-inner-both-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/inner-both.png" class="img-fluid figure-img" alt="一个显示 x 和 y 之间内连接的连接图。结果现在包括四列：key.x、val_x、key.y 和 val_y。key.x 和 key.y 的值是相同的，这就是为什么我们通常只显示一个。 " width="415">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-inner-both-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.12: 一个内连接，在输出中显示 <code>x</code> 和 <code>y</code> 的键。
</figcaption></figure>
</div>
</div>
</div>
<p>当我们从等值连接转向其他类型时，我们将总是显示键，因为键值通常会不同。例如，我们可以不再仅仅在 <code>x$key</code> 和 <code>y$key</code> 相等时匹配，而是在 <code>x$key</code> 大于或等于 <code>y$key</code> 时匹配，这导致了 <a href="#fig-join-gte" class="quarto-xref">Figure&nbsp;<span>19.13</span></a>。dplyr 的连接函数理解等值连接和非等值连接之间的这种区别，所以当你执行非等值连接时，它总是会显示两个键。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-gte" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个说明 join_by(key >= key) 的连接图。x 的第一行匹配 y 的一行，第二行和第三行各匹配两行。这意味着输出有五行，包含以下每一对 (key.x, key.y)：(1, 1), (2, 1), (2, 2), (3, 1), (3, 2)。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-gte-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/gte.png" class="img-fluid figure-img" alt="一个说明 join_by(key >= key) 的连接图。x 的第一行匹配 y 的一行，第二行和第三行各匹配两行。这意味着输出有五行，包含以下每一对 (key.x, key.y)：(1, 1), (2, 1), (2, 2), (3, 1), (3, 2)。" width="385">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-gte-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.13: 一个非等值连接，其中 <code>x</code> 键必须大于或等于 <code>y</code> 键。许多行会产生多个匹配。
</figcaption></figure>
</div>
</div>
</div>
<p>非等值连接不是一个特别有用的术语，因为它只告诉你连接不是什么，而不是它是什么。dplyr 通过识别四种特别有用的非等值连接类型来提供帮助：</p>
<ul>
<li>
<strong>交叉连接 (Cross joins)</strong> 匹配每一对行。</li>
<li>
<strong>不等连接 (Inequality joins)</strong> 使用 <code>&lt;</code>、<code>&lt;=</code>、<code>&gt;</code> 和 <code>&gt;=</code> 而不是 <code>==</code>。</li>
<li>
<strong>滚动连接 (Rolling joins)</strong> 类似于不等连接，但只找到最接近的匹配。</li>
<li>
<strong>重叠连接 (Overlap joins)</strong> 是一种特殊类型的不等连接，旨在处理范围。</li>
</ul>
<p>以下各节将更详细地描述这些类型中的每一种。</p>
<section id="交叉连接" class="level3" data-number="19.5.1"><h3 data-number="19.5.1" class="anchored" data-anchor-id="交叉连接">
<span class="header-section-number">19.5.1</span> 交叉连接</h3>
<p>交叉连接匹配所有内容，如 <a href="#fig-join-cross" class="quarto-xref">Figure&nbsp;<span>19.14</span></a> 所示，生成行的笛卡尔积。这意味着输出将有 <code>nrow(x) * nrow(y)</code> 行。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-cross" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个连接图，为 x 和 y 的每个组合都显示一个点。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-cross-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/cross.png" class="img-fluid figure-img" alt="一个连接图，为 x 和 y 的每个组合都显示一个点。" width="155">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-cross-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.14: 交叉连接将 <code>x</code> 中的每一行与 <code>y</code> 中的每一行进行匹配。
</figcaption></figure>
</div>
</div>
</div>
<p>交叉连接在生成排列时很有用。例如，下面的代码生成了所有可能的名字对。由于我们将 <code>df</code> 与自身连接，这有时被称为<strong>自连接 (self-join)</strong>。交叉连接使用一个不同的连接函数，因为当你匹配每一行时，内/左/右/全连接之间没有区别。</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"John"</span>, <span class="st">"Simon"</span>, <span class="st">"Tracy"</span>, <span class="st">"Max"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/cross_join.html">cross_join</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 16 × 2</span></span>
<span><span class="co">#&gt;   name.x name.y</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;chr&gt; </span></span>
<span><span class="co">#&gt; 1 John   John  </span></span>
<span><span class="co">#&gt; 2 John   Simon </span></span>
<span><span class="co">#&gt; 3 John   Tracy </span></span>
<span><span class="co">#&gt; 4 John   Max   </span></span>
<span><span class="co">#&gt; 5 Simon  John  </span></span>
<span><span class="co">#&gt; 6 Simon  Simon </span></span>
<span><span class="co">#&gt; # ℹ 10 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="不等连接" class="level3" data-number="19.5.2"><h3 data-number="19.5.2" class="anchored" data-anchor-id="不等连接">
<span class="header-section-number">19.5.2</span> 不等连接</h3>
<p>不等连接使用 <code>&lt;</code>、<code>&lt;=</code>、<code>&gt;=</code> 或 <code>&gt;</code> 来限制可能的匹配集，如 <a href="#fig-join-gte" class="quarto-xref">Figure&nbsp;<span>19.13</span></a> 和 <a href="#fig-join-lt" class="quarto-xref">Figure&nbsp;<span>19.15</span></a> 所示。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-lt" class="quarto-float quarto-figure quarto-figure-center anchored" alt="一个描述不等连接的图，其中数据框 x 通过数据框 y 连接，x 的键小于 y 的键，导致左上角形成一个三角形。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-lt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/lt.png" class="img-fluid figure-img" alt="一个描述不等连接的图，其中数据框 x 通过数据框 y 连接，x 的键小于 y 的键，导致左上角形成一个三角形。" width="185">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-lt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.15: 一个不等连接，其中 <code>x</code> 与 <code>y</code> 在 <code>x</code> 的键小于 <code>y</code> 的键的行上连接。这在左上角形成了一个三角形。
</figcaption></figure>
</div>
</div>
</div>
<p>不等连接非常通用，以至于很难想出有意义的具体用例。一个有用的小技巧是使用它们来限制交叉连接，这样我们就可以生成所有组合而不是所有排列：</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"John"</span>, <span class="st">"Simon"</span>, <span class="st">"Tracy"</span>, <span class="st">"Max"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">id</span> <span class="op">&lt;</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 4</span></span>
<span><span class="co">#&gt;    id.x name.x  id.y name.y</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;  &lt;int&gt; &lt;chr&gt; </span></span>
<span><span class="co">#&gt; 1     1 John       2 Simon </span></span>
<span><span class="co">#&gt; 2     1 John       3 Tracy </span></span>
<span><span class="co">#&gt; 3     1 John       4 Max   </span></span>
<span><span class="co">#&gt; 4     2 Simon      3 Tracy </span></span>
<span><span class="co">#&gt; 5     2 Simon      4 Max   </span></span>
<span><span class="co">#&gt; 6     3 Tracy      4 Max</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="滚动连接" class="level3" data-number="19.5.3"><h3 data-number="19.5.3" class="anchored" data-anchor-id="滚动连接">
<span class="header-section-number">19.5.3</span> 滚动连接</h3>
<p>滚动连接是一种特殊类型的不等连接，在这种连接中，你得到的不是满足不等式的<em>每一</em>行，而只是最接近的那一行，如 <a href="#fig-join-closest" class="quarto-xref">Figure&nbsp;<span>19.16</span></a> 所示。你可以通过添加 <code>closest()</code> 将任何不等连接变成滚动连接。例如，<code>join_by(closest(x &lt;= y))</code> 匹配大于或等于 x 的最小的 <code>y</code>，而 <code>join_by(closest(x &gt; y))</code> 匹配小于 <code>x</code> 的最大的 <code>y</code>。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-join-closest" class="quarto-float quarto-figure quarto-figure-center anchored" alt="滚动连接是不等连接的一个子集，所以一些匹配被灰色显示，表示它们没有被使用，因为它们不是“最接近”的。">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-join-closest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="diagrams/join/closest.png" class="img-fluid figure-img" alt="滚动连接是不等连接的一个子集，所以一些匹配被灰色显示，表示它们没有被使用，因为它们不是“最接近”的。" width="262">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-join-closest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.16: 滚动连接类似于大于或等于的不等连接，但只匹配第一个值。
</figcaption></figure>
</div>
</div>
</div>
<p>当你有两个日期表不能完美对齐，并且你想找到（例如）表 1 中在表 2 中某个日期之前（或之后）的最接近的日期时，滚动连接特别有用。</p>
<p>例如，假设你负责你办公室的派对策划委员会。你的公司相当吝啬，所以你们不是举办单独的派对，而是每个季度只举办一次派对。确定派对何时举行的规则有点复杂：派对总是在星期一，你跳过一月的第一周，因为很多人都在度假，而 2022 年第三季度的第一个星期一是 7 月 4 日，所以那必须推迟一周。这导致了以下的派对日期：</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">parties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>  party <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-10"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>现在假设你有一张员工生日表：</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">employees</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu">babynames</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/babynames/man/babynames.html">babynames</a></span><span class="op">$</span><span class="va">name</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  birthday <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2022-01-01"</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">365</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">employees</span></span>
<span><span class="co">#&gt; # A tibble: 100 × 2</span></span>
<span><span class="co">#&gt;   name     birthday  </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 Kemba    2022-01-22</span></span>
<span><span class="co">#&gt; 2 Orean    2022-06-26</span></span>
<span><span class="co">#&gt; 3 Kirstyn  2022-02-11</span></span>
<span><span class="co">#&gt; 4 Amparo   2022-11-11</span></span>
<span><span class="co">#&gt; 5 Belen    2022-03-25</span></span>
<span><span class="co">#&gt; 6 Rayshaun 2022-01-11</span></span>
<span><span class="co">#&gt; # ℹ 94 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>对于每个员工，我们想找到在他们生日前（或生日当天）的最后一个派对日期。我们可以用一个滚动连接来表示这一点：</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">employees</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">parties</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="fu">closest</span><span class="op">(</span><span class="va">birthday</span> <span class="op">&gt;=</span> <span class="va">party</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 100 × 4</span></span>
<span><span class="co">#&gt;   name     birthday       q party     </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;date&gt;     &lt;int&gt; &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 Kemba    2022-01-22     1 2022-01-10</span></span>
<span><span class="co">#&gt; 2 Orean    2022-06-26     2 2022-04-04</span></span>
<span><span class="co">#&gt; 3 Kirstyn  2022-02-11     1 2022-01-10</span></span>
<span><span class="co">#&gt; 4 Amparo   2022-11-11     4 2022-10-03</span></span>
<span><span class="co">#&gt; 5 Belen    2022-03-25     1 2022-01-10</span></span>
<span><span class="co">#&gt; 6 Rayshaun 2022-01-11     1 2022-01-10</span></span>
<span><span class="co">#&gt; # ℹ 94 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然而，这种方法有一个问题：生日在 1 月 10 日之前的员工没有派对：</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">employees</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">parties</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="fu">closest</span><span class="op">(</span><span class="va">birthday</span> <span class="op">&gt;=</span> <span class="va">party</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   name   birthday  </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 Maks   2022-01-07</span></span>
<span><span class="co">#&gt; 2 Nalani 2022-01-04</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>为了解决这个问题，我们需要用一种不同的方式来处理问题，即使用重叠连接。</p>
</section><section id="重叠连接" class="level3" data-number="19.5.4"><h3 data-number="19.5.4" class="anchored" data-anchor-id="重叠连接">
<span class="header-section-number">19.5.4</span> 重叠连接</h3>
<p>重叠连接提供了三个使用不等连接来简化处理区间的辅助函数：</p>
<ul>
<li>
<code>between(x, y_lower, y_upper)</code> 是 <code>x &gt;= y_lower, x &lt;= y_upper</code> 的简写。</li>
<li>
<code>within(x_lower, x_upper, y_lower, y_upper)</code> 是 <code>x_lower &gt;= y_lower, x_upper &lt;= y_upper</code> 的简写。</li>
<li>
<code>overlaps(x_lower, x_upper, y_lower, y_upper)</code> 是 <code>x_lower &lt;= y_upper, x_upper &gt;= y_lower</code> 的简写。</li>
</ul>
<p>让我们继续生日的例子，看看你可能会如何使用它们。我们上面使用的策略有一个问题：在 1 月 1-9 日的生日前没有派对。所以，明确每个派对跨越的日期范围，并为那些早生的生日做一个特殊情况处理可能会更好：</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">parties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>  party <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-10"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  start <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-01"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  end <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-04-03"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-02"</span>, <span class="st">"2022-12-31"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">parties</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 4</span></span>
<span><span class="co">#&gt;       q party      start      end       </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; 2     2 2022-04-04 2022-04-04 2022-07-11</span></span>
<span><span class="co">#&gt; 3     3 2022-07-11 2022-07-11 2022-10-02</span></span>
<span><span class="co">#&gt; 4     4 2022-10-03 2022-10-03 2022-12-31</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Hadley 在数据录入方面非常糟糕，所以他还想检查派对期间是否有重叠。一种方法是使用自连接来检查是否有任何开始-结束区间与另一个重叠：</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">parties</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">parties</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="fu">overlaps</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span>, <span class="va">start</span>, <span class="va">end</span><span class="op">)</span>, <span class="va">q</span> <span class="op">&lt;</span> <span class="va">q</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">start.x</span>, <span class="va">end.x</span>, <span class="va">start.y</span>, <span class="va">end.y</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 4</span></span>
<span><span class="co">#&gt;   start.x    end.x      start.y    end.y     </span></span>
<span><span class="co">#&gt;   &lt;date&gt;     &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 2022-04-04 2022-07-11 2022-07-11 2022-10-02</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>哎呀，有重叠，所以让我们解决这个问题然后继续：</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">parties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>  party <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-10"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  start <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-01-01"</span>, <span class="st">"2022-04-04"</span>, <span class="st">"2022-07-11"</span>, <span class="st">"2022-10-03"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  end <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2022-04-03"</span>, <span class="st">"2022-07-10"</span>, <span class="st">"2022-10-02"</span>, <span class="st">"2022-12-31"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>现在我们可以将每个员工与他们的派对匹配起来了。这是一个使用 <code>unmatched = "error"</code> 的好地方，因为我们想快速发现是否有任何员工没有被分配到派对。</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">employees</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">parties</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">birthday</span>, <span class="va">start</span>, <span class="va">end</span><span class="op">)</span><span class="op">)</span>, unmatched <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 100 × 6</span></span>
<span><span class="co">#&gt;   name     birthday       q party      start      end       </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;date&gt;     &lt;int&gt; &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 Kemba    2022-01-22     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; 2 Orean    2022-06-26     2 2022-04-04 2022-04-04 2022-07-10</span></span>
<span><span class="co">#&gt; 3 Kirstyn  2022-02-11     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; 4 Amparo   2022-11-11     4 2022-10-03 2022-10-03 2022-12-31</span></span>
<span><span class="co">#&gt; 5 Belen    2022-03-25     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; 6 Rayshaun 2022-01-11     1 2022-01-10 2022-01-01 2022-04-03</span></span>
<span><span class="co">#&gt; # ℹ 94 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="练习-2" class="level3" data-number="19.5.5"><h3 data-number="19.5.5" class="anchored" data-anchor-id="练习-2">
<span class="header-section-number">19.5.5</span> 练习</h3>
<ol type="1">
<li>
<p>你能解释一下在这个等值连接中键发生了什么吗？为什么它们不同？</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">key</span> <span class="op">==</span> <span class="va">key</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 3</span></span>
<span><span class="co">#&gt;     key val_x val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1    y1   </span></span>
<span><span class="co">#&gt; 2     2 x2    y2   </span></span>
<span><span class="co">#&gt; 3     3 x3    &lt;NA&gt; </span></span>
<span><span class="co">#&gt; 4     4 &lt;NA&gt;  y3</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by</a></span><span class="op">(</span><span class="va">key</span> <span class="op">==</span> <span class="va">key</span><span class="op">)</span>, keep <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 4</span></span>
<span><span class="co">#&gt;   key.x val_x key.y val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1        1 y1   </span></span>
<span><span class="co">#&gt; 2     2 x2        2 y2   </span></span>
<span><span class="co">#&gt; 3     3 x3       NA &lt;NA&gt; </span></span>
<span><span class="co">#&gt; 4    NA &lt;NA&gt;      4 y3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li><p>在查找是否有任何派对期间与另一个派对期间重叠时，我们在 <code><a href="https://dplyr.tidyverse.org/reference/join_by.html">join_by()</a></code> 中使用了 <code>q &lt; q</code>？为什么？如果移除这个不等式会发生什么？</p></li>
</ol></section></section><section id="总结" class="level2" data-number="19.6"><h2 data-number="19.6" class="anchored" data-anchor-id="总结">
<span class="header-section-number">19.6</span> 总结</h2>
<p>在本章中，你学习了如何使用变连接和过滤连接来组合来自一对数据框的数据。在此过程中，你学习了如何识别键，以及主键和外键之间的区别。你也理解了连接如何工作以及如何计算输出将有多少行。最后，你对非等值连接的力量有了初步的了解，并看到了一些有趣的用例。</p>
<p>本章结束了本书的“转换”部分，该部分的重点是你可以用于单个列和 tibble 的工具。你学习了用于处理逻辑向量、数字和完整表格的 dplyr 和基础函数，用于处理字符串的 stringr 函数，用于处理日期时间的 lubridate 函数，以及用于处理因子的 forcats 函数。</p>
<p>在本书的下一部分，你将学习更多关于如何将各种类型的数据以整洁的形式导入 R 的知识。</p>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>记住，在 RStudio 中你也可以使用 <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code> 来避免这个问题。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>这并非 100% 正确，但每当不是这样时你都会收到一个警告。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/ggvispro\.github\.io\/r4ds-cn\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./missing-values.html" class="pagination-link" aria-label="缺失值">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">缺失值</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./import.html" class="pagination-link" aria-label="导入">
        <span class="nav-page-text">导入</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ggvisPro/r4ds-cn/edit/main/joins.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/ggvisPro/r4ds-cn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>